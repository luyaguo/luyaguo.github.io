<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="第十章 索引优化与查询优化, 向阳">
    <meta name="description" content="第十章 索引优化与查询优化都有哪些维度可以进行数据库调优?简言之:

索引失效、没有充分利用到索引——索引建立
关联查询太多JOIN (设计缺陷或不得已的需求)——SQL优化
服务器调优及各个参数设置(缓冲、线程数等)———调整my.cnf">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>第十章 索引优化与查询优化 | 向阳</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.2.0"></head>

<!-- 预加载动画 -->

    <style type="text/css" lang="css">
    #loading-container{
        position: fixed;
        top: 0;
        left: 0;
        min-height: 100vh;
        width: 100vw;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #2c3561;
        text-align: center;
        /* loader页面消失采用渐隐的方式*/
        -webkit-transition: opacity 1s ease;
        -moz-transition: opacity 1s ease;
        -o-transition: opacity 1s ease;
        transition: opacity 1s ease;
    }
    .loading-image{
        width: 120px;
        height: 50px;
        transform: translate(-50%);
    }

    .loading-image div:nth-child(2) {
        -webkit-animation: pacman-balls 1s linear 0s infinite;
        animation: pacman-balls 1s linear 0s infinite
    }

    .loading-image div:nth-child(3) {
        -webkit-animation: pacman-balls 1s linear .33s infinite;
        animation: pacman-balls 1s linear .33s infinite
    }

    .loading-image div:nth-child(4) {
        -webkit-animation: pacman-balls 1s linear .66s infinite;
        animation: pacman-balls 1s linear .66s infinite
    }

    .loading-image div:nth-child(5) {
        -webkit-animation: pacman-balls 1s linear .99s infinite;
        animation: pacman-balls 1s linear .99s infinite
    }

    .loading-image div:first-of-type {
        width: 0;
        height: 0;
        border: 25px solid #49b1f5;
        border-right-color: transparent;
        border-radius: 25px;
        -webkit-animation: rotate_pacman_half_up .5s 0s infinite;
        animation: rotate_pacman_half_up .5s 0s infinite;
    }
    .loading-image div:nth-child(2) {
        width: 0;
        height: 0;
        border: 25px solid #49b1f5;
        border-right-color: transparent;
        border-radius: 25px;
        -webkit-animation: rotate_pacman_half_down .5s 0s infinite;
        animation: rotate_pacman_half_down .5s 0s infinite;
        margin-top: -50px;
    }
    @-webkit-keyframes rotate_pacman_half_up {0% {transform: rotate(270deg)}50% {transform: rotate(1turn)}to {transform: rotate(270deg)}}

    @keyframes rotate_pacman_half_up {0% {transform: rotate(270deg)}50% {transform: rotate(1turn)}to {transform: rotate(270deg)}}

    @-webkit-keyframes rotate_pacman_half_down {0% {transform: rotate(90deg)}50% {transform: rotate(0deg)}to {transform: rotate(90deg)}}

    @keyframes rotate_pacman_half_down {0% {transform: rotate(90deg)}50% {transform: rotate(0deg)}to {transform: rotate(90deg)}}

    @-webkit-keyframes pacman-balls {75% {opacity: .7}to {transform: translate(-100px, -6.25px)}}

    @keyframes pacman-balls {75% {opacity: .7}to {transform: translate(-100px, -6.25px)}}


    .loading-image div:nth-child(3),
    .loading-image div:nth-child(4),
    .loading-image div:nth-child(5),
    .loading-image div:nth-child(6){
        background-color: #49b1f5;
        width: 15px;
        height: 15px;
        border-radius: 100%;
        margin: 2px;
        width: 10px;
        height: 10px;
        position: absolute;
        transform: translateY(-6.25px);
        top: 25px;
        left: 100px;
    }
    .loading-text{
        margin-bottom: 20vh;
        text-align: center;
        color: #f8c471;
        font-size: 2rem;
        box-sizing: border-box;
        padding: 0 10px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    @media only screen and (max-width: 500px) {
        .loading-text{
            font-size: 1.5rem;
        }
    }
    .fadeout {
        opacity: 0;
        filter: alpha(opacity=0);
    }
    /* logo出现动画 */
    @-webkit-keyframes fadeInDown{0%{opacity:0;-webkit-transform:translate3d(0,-100%,0);transform:translate3d(0,-100%,0)}100%{opacity:1;-webkit-transform:none;transform:none}}
    @keyframes fadeInDown{0%{opacity:0;-webkit-transform:translate3d(0,-100%,0);}}
</style>
<script>
    (function () {
        const loaded = function(){
            setTimeout(function(){
                const loader = document.getElementById("loading-container");
                loader.className="fadeout" ;//使用渐隐的方法淡出loading page
                // document.getElementById("body-wrap").style.display="flex";
                setTimeout(function(){
                    loader.style.display="none";
                },2500);
            },800);//强制显示loading page 0.8s
        };
        loaded();
    })()
</script>

<body>
    <!--动态背景-->
    <div id="bg"><canvas></canvas><canvas></canvas><canvas></canvas></div>
    <script src="/js/canva_moving_effect.js"></script>

    
        <div id="loading-container">
            <p class="loading-text">客官坐会儿，请稍等片刻. . . </p>
            <div class="loading-image">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
    

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    <div>&nbsp;
                        
                            <img src="/medias/logo2.png" class="logo-img" alt="LOGO">
                        
                        <span class="logo-span">向阳</span>
                    </div>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>Tags</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>Categories</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>About</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>Friends</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.95;"></i>
    </a>
  </li>

  <!-- 全屏 -->
<!--   <li id="fullscreen_li" class="fullscreen"> -->
<!--     <a href="javascript:void(0);" class="modal-trigger waves-effect waves-light"> -->
<!--       <i id="fullscreen" class="fas fa-expand-arrows-alt" title="全屏" style="zoom: 0.85;"></i> -->
<!--     </a> -->
<!--   </li> -->

  <!-- 主题背景 -->
  <li>
    <a href="javascript:;" class="modal-trigger waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
  &nbsp;
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo2.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">向阳</div>
        <div class="logo-desc">
            
            Never give up and never give in...
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			Tags
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			Categories
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			About
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			Friends
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/13.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">第十章 索引优化与查询优化</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/MySQL-%E8%BF%9B%E9%98%B6/">
                                <span class="chip bg-color">MySQL 进阶</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/MySQL-%E8%BF%9B%E9%98%B6/" class="post-category">
                                MySQL 进阶
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2025-08-08
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>Word Count:&nbsp;&nbsp;
                    19.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>Read Times:&nbsp;&nbsp;
                    78 Min
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>Read Count:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="第十章-索引优化与查询优化"><a href="#第十章-索引优化与查询优化" class="headerlink" title="第十章 索引优化与查询优化"></a>第十章 索引优化与查询优化</h1><p>都有哪些维度可以进行数据库调优?简言之:</p>
<ul>
<li>索引失效、没有充分利用到索引——索引建立</li>
<li>关联查询太多JOIN (设计缺陷或不得已的需求)——SQL优化</li>
<li>服务器调优及各个参数设置(缓冲、线程数等)———调整my.cnf。</li>
<li>数据过多――分库分表</li>
</ul>
<p>关于数据库调优的知识点非常分散。不同的DBMS，不同的公司，不同的职位，不同的项目遇到的问题都不尽相同。这里我们分为三个章节进行细致讲解。</p>
<p>虽然SQL查询优化的技术有很多，但是大方向上完全可以分成<code>物理查询优化</code>和<code>逻辑查询优化</code>两大块。</p>
<ul>
<li>物理查询优化是通过<code>索引</code>和<code>表连接方式</code>等技术来进行优化，这里重点需要掌握索引的使用。</li>
<li>逻辑查询优化就是通过SQL<code>等价变换</code>提升查询效率，直白一点就是说，换一种查询写法执行效率可能更高。</li>
</ul>
<p>&#x3D;&#x3D;数据准备&#x3D;&#x3D;</p>
<p>学员表 插 50万 条， 班级表 插 1万 条。</p>
<ul>
<li>步骤1：建表</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>class<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>className<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>address<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>monitor<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>student<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>stuno<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>classId<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token comment">#CONSTRAINT `fk_class_id` FOREIGN KEY (`classId`) REFERENCES `t_class` (`id`)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>步骤2：设置参数</li>
</ul>
<p>命令开启：允许创建函数设置：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> <span class="token keyword">global</span> log_bin_trust_function_creators<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 
<span class="token comment">-- 不加global只是当前窗口有效。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>步骤3：创建函数</li>
</ul>
<p>保证每条数据都不同。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#随机产生字符串</span>
<span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_string<span class="token punctuation">(</span>n <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">DECLARE</span> chars_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span>
<span class="token string">'abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> return_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">WHILE</span> i <span class="token operator">&lt;</span> n <span class="token keyword">DO</span>
<span class="token keyword">SET</span> return_str <span class="token operator">=</span>CONCAT<span class="token punctuation">(</span>return_str<span class="token punctuation">,</span>SUBSTRING<span class="token punctuation">(</span>chars_str<span class="token punctuation">,</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> return_str<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">-- 假如要删除</span>
<span class="token comment">-- drop function rand_string;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>随机产生班级编号</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 用于随机产生多少到多少的编号</span>
<span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_num <span class="token punctuation">(</span>from_num <span class="token keyword">INT</span> <span class="token punctuation">,</span>to_num <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> i <span class="token operator">=</span> FLOOR<span class="token punctuation">(</span>from_num <span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>to_num <span class="token operator">-</span> from_num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> i<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">-- 假如要删除</span>
<span class="token comment">-- drop function rand_num;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>步骤4：创建存储过程</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建往stu表中插入数据的存储过程</span>
<span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_stu<span class="token punctuation">(</span> <span class="token keyword">START</span> <span class="token keyword">INT</span> <span class="token punctuation">,</span> max_num <span class="token keyword">INT</span> <span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">#设置手动提交事务</span>
<span class="token keyword">REPEAT</span> <span class="token comment">#循环</span>
<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">#赋值</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> student <span class="token punctuation">(</span>stuno<span class="token punctuation">,</span> name <span class="token punctuation">,</span>age <span class="token punctuation">,</span>classId <span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">START</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rand_num<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rand_num<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UNTIL i <span class="token operator">=</span> max_num
<span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span> <span class="token comment">#提交事务</span>
<span class="token keyword">END</span> <span class="token comment">//</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">-- 假如要删除</span>
<span class="token comment">-- drop PROCEDURE insert_stu;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建往class表中插入数据的存储过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#执行存储过程，往class表添加随机数据</span>
<span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token identifier"><span class="token punctuation">`</span>insert_class<span class="token punctuation">`</span></span><span class="token punctuation">(</span> max_num <span class="token keyword">INT</span> <span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">REPEAT</span>
<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class <span class="token punctuation">(</span> classname<span class="token punctuation">,</span>address<span class="token punctuation">,</span>monitor <span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
<span class="token punctuation">(</span>rand_string<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rand_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rand_num<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UNTIL i <span class="token operator">=</span> max_num
<span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment">#假如要删除</span>
<span class="token comment">#drop PROCEDURE insert_class;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>步骤5：调用存储过程</li>
</ul>
<p>class</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 执行存储过程，往class表添加1万条数据</span>
<span class="token keyword">CALL</span> insert_class<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>stu</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 执行存储过程，往stu表添加50万条数据</span>
<span class="token keyword">CALL</span> insert_stu<span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span><span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>步骤6：删除某表上的索引</li>
</ul>
<p>创建存储过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token identifier"><span class="token punctuation">`</span>proc_drop_index<span class="token punctuation">`</span></span><span class="token punctuation">(</span>dbname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>tablename <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">DECLARE</span> done <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">DECLARE</span> ct <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">DECLARE</span> _index <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">DECLARE</span> _cur <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> <span class="token keyword">SELECT</span> index_name <span class="token keyword">FROM</span>
  information_schema<span class="token punctuation">.</span><span class="token keyword">STATISTICS</span> <span class="token keyword">WHERE</span> table_schema<span class="token operator">=</span>dbname <span class="token operator">AND</span> table_name<span class="token operator">=</span>tablename <span class="token operator">AND</span>
  seq_in_index<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> index_name <span class="token operator">&lt;></span><span class="token string">'PRIMARY'</span> <span class="token punctuation">;</span>
  <span class="token comment">-- 每个游标必须使用不同的declare continue handler for not found set done=1来控制游标的结束</span>
  <span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token keyword">set</span> done<span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">;</span>
  <span class="token comment">-- 若没有数据返回,程序继续,并将变量done设为2</span>
  <span class="token keyword">OPEN</span> _cur<span class="token punctuation">;</span>
  <span class="token keyword">FETCH</span> _cur <span class="token keyword">INTO</span> _index<span class="token punctuation">;</span>
  <span class="token keyword">WHILE</span> _index<span class="token operator">&lt;></span><span class="token string">''</span> <span class="token keyword">DO</span>
  <span class="token keyword">SET</span> <span class="token variable">@str</span> <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span><span class="token string">"drop index "</span> <span class="token punctuation">,</span> _index <span class="token punctuation">,</span> <span class="token string">" on "</span> <span class="token punctuation">,</span> tablename <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">PREPARE</span> sql_str <span class="token keyword">FROM</span> <span class="token variable">@str</span> <span class="token punctuation">;</span>
  <span class="token keyword">EXECUTE</span> sql_str<span class="token punctuation">;</span>
  <span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> sql_str<span class="token punctuation">;</span>
  <span class="token keyword">SET</span> _index<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">FETCH</span> _cur <span class="token keyword">INTO</span> _index<span class="token punctuation">;</span>
  <span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
  <span class="token keyword">CLOSE</span> _cur<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行存储过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">"dbname"</span><span class="token punctuation">,</span><span class="token string">"tablename"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h2 id="1、索引失效案例"><a href="#1、索引失效案例" class="headerlink" title="1、索引失效案例"></a>1、索引失效案例</h2><p>MySQL中<code>提高性能</code>的一个最有效的方式是对数据表<code>设计合理的索引</code>。索引提供了访问高效数据的方法，并且加快查询的速度，因此索引对查询的速度有着至关重要的影响。</p>
<ul>
<li>使用索引可以<code>快速地定位</code>表中的某条记录，从而提高数据库查询的速度，提高数据库的性能。</li>
<li>如果查询时没有使用索引，查询语句就会<code>扫描表中的所有记录</code>。在数据量大的情况下，这样查询的速度会很慢。</li>
</ul>
<p>大多数情况下都（默认）采用<code>B+树</code>来构建索引。只是空间列类型的索引使用<code>R-树</code>，并且MEMORY表还支持<code>hash索引</code>。</p>
<p>其实，用不用索引，最终都是优化器说了算。优化器是基于什么的优化器？基于<code>cost开销(CostBaseOptimizer)</code>，它不是基于<code>规则(Rule-BasedOptimizer)</code>，也不是基于<code>语义</code>。怎么样开销小就怎么来。另外，<strong>SQL语句是否使用索引，跟数据库版本、数据量、数据选择度都有关系。</strong></p>
<blockquote>
<p>开销不是基于时间</p>
</blockquote>
<h3 id="1-1-全值匹配我最爱"><a href="#1-1-全值匹配我最爱" class="headerlink" title="1.1 全值匹配我最爱"></a><strong>1.1</strong> <strong>全值匹配我最爱</strong></h3><p>意思是创建联合索引多个索引同时生效。</p>
<p>系统中经常出现的sql语句如下:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age&#x3D;30;
EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age&#x3D;30 and classId&#x3D;4;
EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age&#x3D;30 and classId&#x3D;4 AND name &#x3D; &#39;abcd&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>建立索引前执行:(关注执行时间)</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; SELECT SQL_NO_CACHE * FROM student WHERE age&#x3D;30 and classId&#x3D;4 AND name &#x3D; &#39;abcd&#39; ;
Empty set，1 warning ( 0.28 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<p>建立索引</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE INDEX idx_age ON student(age ) ;

CREATE INDEX idx_age_classid ON student( age , classId);

CREATE INDEX idx_age_classid_name ON student( age , classId , name) ;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>建立索引后执行:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; SELECT SQL_NO_CACHE * FROM student WHERE age&#x3D;30 and classId&#x3D;4 AND name &#x3D; &#39;abcd&#39;;
Empty set,1 warning (0.01 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>可以看到，创建索引前的查询时间是0 .28秒，创建索引后的查询时间是0.01秒，索引帮助我们极大的提高了查询效率。</p>
<h3 id="1-2-最佳左前缀法则"><a href="#1-2-最佳左前缀法则" class="headerlink" title="1.2 最佳左前缀法则"></a><strong>1.2</strong> <strong>最佳左前缀法则</strong></h3><p>​	在MySQL建立联合索引时会遵守最佳左前缀匹配原则，即最左优先，在检索数据时从联合索引的最左边开始匹配。</p>
<p>举例1:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.age&#x3D;30 AND student.name &#x3D; &#39;abcd&#39;;
# 走&#96;idx_age_classid_name&#96;   使用了Using index condition<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p>举例2:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.classid&#x3D;1 AND student.name &#x3D; &#39;abcd&#39; ;

# 没有索引匹配上。 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<p>举例3:<strong>索引idx_age_classid_name还能否正常使用?</strong></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE classid&#x3D;4 and student.age&#x3D;30 AND student.name &#x3D; &#39;abcd&#39; ;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果索引了多列，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且不跳过索引中的列。</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysq1&gt; EXPLAIN SELECT SQL_NO_CACHE* FROM student WHERE student.age&#x3D;30 AND student.name &#x3D;&#39;abcd&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080045616.png" alt="image-20220326224834648"></p>
<p>结论：MySQL可以为多个字段创建索引，一个索引可以包括16个字段。对于多列索引，<strong>过滤条件要使用索引必须按照索引建立时的顺序，依次满足，一旦跳过某个字段，索引后面的字段都无法被使用。</strong>如果查询条件中没有使用这些字段中第1个字段时，多列（或联合）索引不会被使用。</p>
<blockquote>
<p>拓展：Alibaba《Java开发手册》 </p>
<p>索引文件具有 B-Tree 的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引。</p>
</blockquote>
<h3 id="1-3-主键插入顺序"><a href="#1-3-主键插入顺序" class="headerlink" title="1.3 主键插入顺序"></a><strong>1.3</strong> <strong>主键插入顺序</strong></h3><p>​	对于一个使用<code>InnoDB</code>存储引擎的表来说，在我们没有显示的创建索引时，表中的数据实际上都是存储在<code>聚簇索引</code>的叶子节点的。而记录又存储在数据页中的，数据页和记录又是按照记录<code>主键值从小到大</code>的顺序进行排序，所以如果我们<code>插入</code>的记录的<code>主键值是依次增大</code>的话，那我们每插满一个数据页就换到下一个数据页继续插，而如果我们插入的<code>主键值忽小忽大</code>的话，则可能会造成<code>页面分裂</code>和<code>记录移位</code>。</p>
<p>假设某个数据页存储的记录已经满了，它存储的主键值在<code>1~100</code>之间:</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080044846.png" alt="image-20220628212842688"></p>
<p>​	如果此时再插入一条主键值为 9 的记录，那它插入的位置就如下图：</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080044164.png" alt="image-20220628212854685"></p>
<p>​	可这个数据页已经满了，再插进来咋办呢？我们需要把当前 页面分裂 成两个页面，把本页中的一些记录 移动到新创建的这个页中。页面分裂和记录移位意味着什么？意味着： 性能损耗 ！所以如果我们想尽量 避免这样无谓的性能损耗，最好让插入的记录的 主键值依次递增 ，这样就不会发生这样的性能损耗了。 所以我们建议：让主键具有 AUTO_INCREMENT ，让存储引擎自己为表生成主键，而不是我们手动插入 ， 比如： person_info 表：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> person_info<span class="token punctuation">(</span>
  id <span class="token keyword">INT</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  birthday <span class="token keyword">DATE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  phone_number <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  country <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> idx_name_birthday_phone_number <span class="token punctuation">(</span>name<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> birthday<span class="token punctuation">,</span> phone_number<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	我们自定义的主键列 id 拥有 AUTO_INCREMENT 属性，在插入记录时存储引擎会自动为我们填入自增的 主键值。这样的主键占用空间小，顺序写入，减少页分裂。</p>
<h3 id="1-4-计算、函数、类型转换-自动或手动-导致索引失效"><a href="#1-4-计算、函数、类型转换-自动或手动-导致索引失效" class="headerlink" title="1.4 计算、函数、类型转换(自动或手动)导致索引失效"></a>1.4 计算、函数、类型转换(自动或手动)导致索引失效</h3><p>1.这两条sql哪种写法更好</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> student<span class="token punctuation">.</span>name <span class="token operator">LIKE</span> <span class="token string">'abc%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span>
<span class="token comment">-- 这个索引失效。因为用上函数了。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>创建索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_name <span class="token keyword">ON</span> student<span class="token punctuation">(</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>第一种：索引优化生效</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> student<span class="token punctuation">.</span>name <span class="token operator">LIKE</span> <span class="token string">'abc%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> student<span class="token punctuation">.</span>name <span class="token operator">LIKE</span> <span class="token string">'abc%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token operator">|</span> id 			<span class="token operator">|</span> stuno 	<span class="token operator">|</span> name 	 <span class="token operator">|</span> age  <span class="token operator">|</span> classId <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token operator">|</span> <span class="token number">5301379</span> <span class="token operator">|</span> <span class="token number">1233401</span> <span class="token operator">|</span> AbCHEa <span class="token operator">|</span> <span class="token number">164</span> <span class="token operator">|</span> <span class="token number">259</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7170042</span> <span class="token operator">|</span> <span class="token number">3102064</span> <span class="token operator">|</span> ABcHeB <span class="token operator">|</span> <span class="token number">199</span> <span class="token operator">|</span> <span class="token number">161</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1901614</span> <span class="token operator">|</span> <span class="token number">1833636</span> <span class="token operator">|</span> ABcHeC <span class="token operator">|</span> <span class="token number">226</span> <span class="token operator">|</span> <span class="token number">275</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5195021</span> <span class="token operator">|</span> <span class="token number">1127043</span> <span class="token operator">|</span> abchEC <span class="token operator">|</span> <span class="token number">486</span> <span class="token operator">|</span> <span class="token number">72</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4047089</span> <span class="token operator">|</span> <span class="token number">3810031</span> <span class="token operator">|</span> AbCHFd <span class="token operator">|</span> <span class="token number">268</span> <span class="token operator">|</span> <span class="token number">210</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4917074</span> <span class="token operator">|</span> <span class="token number">849096</span>  <span class="token operator">|</span> ABcHfD <span class="token operator">|</span> <span class="token number">264</span> <span class="token operator">|</span> <span class="token number">442</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1540859</span> <span class="token operator">|</span> <span class="token number">141979</span>  <span class="token operator">|</span> abchFF <span class="token operator">|</span> <span class="token number">119</span> <span class="token operator">|</span> <span class="token number">140</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5121801</span> <span class="token operator">|</span> <span class="token number">1053823</span> <span class="token operator">|</span> AbCHFg <span class="token operator">|</span> <span class="token number">412</span> <span class="token operator">|</span> <span class="token number">327</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2441254</span> <span class="token operator">|</span> <span class="token number">2373276</span> <span class="token operator">|</span> abchFJ <span class="token operator">|</span> <span class="token number">170</span> <span class="token operator">|</span> <span class="token number">362</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7039146</span> <span class="token operator">|</span> <span class="token number">2971168</span> <span class="token operator">|</span> ABcHgI <span class="token operator">|</span> <span class="token number">502</span> <span class="token operator">|</span> <span class="token number">465</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1636826</span> <span class="token operator">|</span> <span class="token number">1580286</span> <span class="token operator">|</span> ABcHgK <span class="token operator">|</span> <span class="token number">71</span> <span class="token operator">|</span> <span class="token number">262</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">374344</span>  <span class="token operator">|</span> <span class="token number">474345</span>  <span class="token operator">|</span> abchHL <span class="token operator">|</span> <span class="token number">367</span> <span class="token operator">|</span> <span class="token number">212</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1596534</span> <span class="token operator">|</span> <span class="token number">169191</span>  <span class="token operator">|</span> AbCHHl <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> <span class="token number">146</span> <span class="token operator">|</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">|</span> <span class="token number">5266837</span> <span class="token operator">|</span> <span class="token number">1198859</span> <span class="token operator">|</span> abclXe <span class="token operator">|</span> <span class="token number">292</span> <span class="token operator">|</span> <span class="token number">298</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">8126968</span> <span class="token operator">|</span> <span class="token number">4058990</span> <span class="token operator">|</span> aBClxE <span class="token operator">|</span> <span class="token number">316</span> <span class="token operator">|</span> <span class="token number">150</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4298305</span> <span class="token operator">|</span> <span class="token number">399962</span>  <span class="token operator">|</span> AbCLXF <span class="token operator">|</span> <span class="token number">72</span> <span class="token operator">|</span> <span class="token number">423</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5813628</span> <span class="token operator">|</span> <span class="token number">1745650</span> <span class="token operator">|</span> aBClxF <span class="token operator">|</span> <span class="token number">356</span> <span class="token operator">|</span> <span class="token number">323</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6980448</span> <span class="token operator">|</span> <span class="token number">2912470</span> <span class="token operator">|</span> AbCLXF <span class="token operator">|</span> <span class="token number">107</span> <span class="token operator">|</span> <span class="token number">78</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7881979</span> <span class="token operator">|</span> <span class="token number">3814001</span> <span class="token operator">|</span> AbCLXF <span class="token operator">|</span> <span class="token number">89</span> <span class="token operator">|</span> <span class="token number">497</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4955576</span> <span class="token operator">|</span> <span class="token number">887598</span>  <span class="token operator">|</span> ABcLxg <span class="token operator">|</span> <span class="token number">121</span> <span class="token operator">|</span> <span class="token number">385</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3653460</span> <span class="token operator">|</span> <span class="token number">3585482</span> <span class="token operator">|</span> AbCLXJ <span class="token operator">|</span> <span class="token number">130</span> <span class="token operator">|</span> <span class="token number">174</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1231990</span> <span class="token operator">|</span> <span class="token number">1283439</span> <span class="token operator">|</span> AbCLYH <span class="token operator">|</span> <span class="token number">189</span> <span class="token operator">|</span> <span class="token number">429</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6110615</span> <span class="token operator">|</span> <span class="token number">2042637</span> <span class="token operator">|</span> ABcLyh <span class="token operator">|</span> <span class="token number">157</span> <span class="token operator">|</span> <span class="token number">40</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token number">401</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第二种：索引优化失效</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080044191.png" alt="image-20220628213444651"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span>student<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token operator">|</span> id 			<span class="token operator">|</span> stuno 	<span class="token operator">|</span> name 	 <span class="token operator">|</span> age 	<span class="token operator">|</span> classId <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token operator">|</span> <span class="token number">5301379</span> <span class="token operator">|</span> <span class="token number">1233401</span> <span class="token operator">|</span> AbCHEa <span class="token operator">|</span> <span class="token number">164</span> <span class="token operator">|</span> <span class="token number">259</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7170042</span> <span class="token operator">|</span> <span class="token number">3102064</span> <span class="token operator">|</span> ABcHeB <span class="token operator">|</span> <span class="token number">199</span> <span class="token operator">|</span> <span class="token number">161</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1901614</span> <span class="token operator">|</span> <span class="token number">1833636</span> <span class="token operator">|</span> ABcHeC <span class="token operator">|</span> <span class="token number">226</span> <span class="token operator">|</span> <span class="token number">275</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5195021</span> <span class="token operator">|</span> <span class="token number">1127043</span> <span class="token operator">|</span> abchEC <span class="token operator">|</span> <span class="token number">486</span> <span class="token operator">|</span> <span class="token number">72</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4047089</span> <span class="token operator">|</span> <span class="token number">3810031</span> <span class="token operator">|</span> AbCHFd <span class="token operator">|</span> <span class="token number">268</span> <span class="token operator">|</span> <span class="token number">210</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4917074</span> <span class="token operator">|</span> <span class="token number">849096</span>  <span class="token operator">|</span> ABcHfD <span class="token operator">|</span> <span class="token number">264</span> <span class="token operator">|</span> <span class="token number">442</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1540859</span> <span class="token operator">|</span> <span class="token number">141979</span>  <span class="token operator">|</span> abchFF <span class="token operator">|</span> <span class="token number">119</span> <span class="token operator">|</span> <span class="token number">140</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5121801</span> <span class="token operator">|</span> <span class="token number">1053823</span> <span class="token operator">|</span> AbCHFg <span class="token operator">|</span> <span class="token number">412</span> <span class="token operator">|</span> <span class="token number">327</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2441254</span> <span class="token operator">|</span> <span class="token number">2373276</span> <span class="token operator">|</span> abchFJ <span class="token operator">|</span> <span class="token number">170</span> <span class="token operator">|</span> <span class="token number">362</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7039146</span> <span class="token operator">|</span> <span class="token number">2971168</span> <span class="token operator">|</span> ABcHgI <span class="token operator">|</span> <span class="token number">502</span> <span class="token operator">|</span> <span class="token number">465</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1636826</span> <span class="token operator">|</span> <span class="token number">1580286</span> <span class="token operator">|</span> ABcHgK <span class="token operator">|</span> <span class="token number">71</span> <span class="token operator">|</span> <span class="token number">262</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">374344</span> <span class="token operator">|</span> <span class="token number">474345</span>   <span class="token operator">|</span> abchHL <span class="token operator">|</span> <span class="token number">367</span> <span class="token operator">|</span> <span class="token number">212</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1596534</span> <span class="token operator">|</span> <span class="token number">169191</span>  <span class="token operator">|</span> AbCHHl <span class="token operator">|</span> <span class="token number">102</span> <span class="token operator">|</span> <span class="token number">146</span> <span class="token operator">|</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">|</span> <span class="token number">5266837</span> <span class="token operator">|</span> <span class="token number">1198859</span> <span class="token operator">|</span> abclXe <span class="token operator">|</span> <span class="token number">292</span> <span class="token operator">|</span> <span class="token number">298</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">8126968</span> <span class="token operator">|</span> <span class="token number">4058990</span> <span class="token operator">|</span> aBClxE <span class="token operator">|</span> <span class="token number">316</span> <span class="token operator">|</span> <span class="token number">150</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4298305</span> <span class="token operator">|</span> <span class="token number">399962</span>  <span class="token operator">|</span> AbCLXF <span class="token operator">|</span> <span class="token number">72</span> <span class="token operator">|</span> <span class="token number">423</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5813628</span> <span class="token operator">|</span> <span class="token number">1745650</span> <span class="token operator">|</span> aBClxF <span class="token operator">|</span> <span class="token number">356</span> <span class="token operator">|</span> <span class="token number">323</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6980448</span> <span class="token operator">|</span> <span class="token number">2912470</span> <span class="token operator">|</span> AbCLXF <span class="token operator">|</span> <span class="token number">107</span> <span class="token operator">|</span> <span class="token number">78</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">7881979</span> <span class="token operator">|</span> <span class="token number">3814001</span> <span class="token operator">|</span> AbCLXF <span class="token operator">|</span> <span class="token number">89</span> <span class="token operator">|</span> <span class="token number">497</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4955576</span> <span class="token operator">|</span> <span class="token number">887598</span>  <span class="token operator">|</span> ABcLxg <span class="token operator">|</span> <span class="token number">121</span> <span class="token operator">|</span> <span class="token number">385</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3653460</span> <span class="token operator">|</span> <span class="token number">3585482</span> <span class="token operator">|</span> AbCLXJ <span class="token operator">|</span> <span class="token number">130</span> <span class="token operator">|</span> <span class="token number">174</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1231990</span> <span class="token operator">|</span> <span class="token number">1283439</span> <span class="token operator">|</span> AbCLYH <span class="token operator">|</span> <span class="token number">189</span> <span class="token operator">|</span> <span class="token number">429</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6110615</span> <span class="token operator">|</span> <span class="token number">2042637</span> <span class="token operator">|</span> ABcLyh <span class="token operator">|</span> <span class="token number">157</span> <span class="token operator">|</span> <span class="token number">40</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+---------+--------+------+---------+</span>
<span class="token number">401</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">3.62</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>type为“ALL”，表示没有使用到索引，查询时间为 3.62 秒，查询效率较之前低很多。</p>
<p>再举例：student表的字段stuno上设置有索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_sno <span class="token keyword">ON</span> student<span class="token punctuation">(</span>stuno<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE id<span class="token punctuation">,</span> stuno<span class="token punctuation">,</span> NAME <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> stuno<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token number">900001</span><span class="token punctuation">;</span>
<span class="token comment">-- 计算导致索引失效</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>运行结果：</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080044495.png" alt="image-20220628213457357"></p>
<p>类型是ALL原因是计算导致了索引失效。</p>
<p>索引优化生效(没有计算)：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE id<span class="token punctuation">,</span> stuno<span class="token punctuation">,</span> NAME <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> stuno <span class="token operator">=</span> <span class="token number">900000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080044685.png" alt="image-20220326230203661"></p>
<p>再举例： student表的字段name上设置有索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_name <span class="token keyword">ON</span> student<span class="token punctuation">(</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 上面已经运行过了</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> stuno<span class="token punctuation">,</span> name <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> SUBSTRING<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'abc'</span><span class="token punctuation">;</span>
<span class="token comment">-- 使用函数导致失效，可以改用like abc%</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080044271.png" alt="image-20220628213509267"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> stuno<span class="token punctuation">,</span> NAME <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'abc%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080044832.png" alt="image-20220628213516750"></p>
<h3 id="1-5-类型转换导致索引失效"><a href="#1-5-类型转换导致索引失效" class="headerlink" title="1.5 类型转换导致索引失效"></a><strong>1.5</strong> <strong>类型转换导致索引失效</strong></h3><p>下列哪个sql语句可以用到索引。（假设name字段上设置有索引）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 未使用到索引</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">;</span>
<span class="token comment">-- name=123发生类型转换，索引失效</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080044758.png" alt="image-20220628213618270"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 使用到索引</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080044422.png" alt="image-20220628213624893"></p>
<h3 id="1-6-范围条件右边的列索引失效"><a href="#1-6-范围条件右边的列索引失效" class="headerlink" title="1.6 范围条件右边的列索引失效"></a><strong>1.6</strong> <strong>范围条件右边的列索引失效</strong></h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> student <span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_name<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> student <span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age<span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> student <span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_classid<span class="token punctuation">;</span>

<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> student<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">30</span> <span class="token operator">AND</span> student<span class="token punctuation">.</span>classId<span class="token operator">></span><span class="token number">20</span> <span class="token operator">AND</span> student<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'abc'</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080043593.png" alt="image-20220628213756327"></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080043612.png" alt="image-20220326234953835"></p>
<p>因为用上了范围查找，，在范围查找的索引后面的索引就失效了。</p>
<blockquote>
<p>tips ： 因为范围条件导致的索引失效，可以考虑把确定的索引放在前面。</p>
<p>例如上面这个例子，</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">create index idx_age_name_cid on student(age, name, classId);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里name 放在了范围查找 classId前面。。索引就能生效了。</p>
</blockquote>
<p>将范围查询条件放置语句最后：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> student<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> student<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'abc'</span> <span class="token operator">AND</span> student<span class="token punctuation">.</span>classId <span class="token operator">></span> <span class="token number">20</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080043351.png" alt="image-20220628213823950"></p>
<blockquote>
<p>应用开发中范围查询，例如：金额查询，日期查询往往都是范围查询。应将查询条件放置where语句最后。（创建的联合索引中，务必把范围涉及到的字段写在最后）</p>
</blockquote>
<p><strong>哪些属于范围？</strong></p>
<ol>
<li>大于等于，大于，小于等于，小于</li>
<li><code>between</code></li>
</ol>
<blockquote>
<p>应用开发中范围查询，例如： 金额查询，日期查询往往都是范围查询。创建联合索引时考虑放在后面。</p>
</blockquote>
<h3 id="1-7-不等于-或者-索引失效"><a href="#1-7-不等于-或者-索引失效" class="headerlink" title="1.7 不等于(!&#x3D; 或者&lt;&gt;)索引失效"></a><strong>1.7</strong> <strong>不等于(!&#x3D; 或者&lt;&gt;)索引失效</strong></h3><ul>
<li><p>为name字段创建索引</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE INDEX idx_name ON student(NAME);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


</li>
<li><p>查看索引是否失效</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.name &#x3D;&#39;abc&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080043580.png" alt="image-20220327000012828"></p>
</li>
</ul>
<blockquote>
<p> 没救 索引只能查到知道的东西</p>
</blockquote>
<h3 id="1-8-is-null可以使用索引，is-not-null无法使用索引"><a href="#1-8-is-null可以使用索引，is-not-null无法使用索引" class="headerlink" title="1.8 is null可以使用索引，is not null无法使用索引"></a><strong>1.8 is null可以使用索引，is not null无法使用索引</strong></h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080043777.png" alt="image-20220327000138701"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- is not null 索引失效</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080043505.png" alt="image-20220327000222914"></p>
<blockquote>
<p>结论：最好在设计数据表的时候就将<code>字段设置为 NOT NULL 约束</code>，比如你可以将INT类型的字段，默认值设置为0。将字符类型的默认值设置为空字符串(‘’)</p>
<p>拓展：同理，在查询中使用<code>not like</code>也无法使用索引，导致全表扫描</p>
</blockquote>
<h3 id="1-9-like以通配符-开头索引失效"><a href="#1-9-like以通配符-开头索引失效" class="headerlink" title="1.9 like以通配符%开头索引失效"></a>1.9 like以通配符%开头索引失效</h3><p>在使用LIKE关键字进行查询的查询语句中，如果匹配字符串的第一个字符为“%”，索引就不会起作用。只有“%”不在第一个位置，索引才会起作用。</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080043040.png" alt="image-20220628214138171"></p>
<blockquote>
<p>拓展：Alibaba《Java开发手册》</p>
<p>【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决。</p>
</blockquote>
<h3 id="1-10-OR-前后存在非索引的列，索引失效"><a href="#1-10-OR-前后存在非索引的列，索引失效" class="headerlink" title="1.10 OR 前后存在非索引的列，索引失效"></a>1.10 OR 前后存在非索引的列，索引失效</h3><p>在WHERE子句中，如果在OR前的条件列进行了索引，而在OR后的条件列没有进行索引，那么索引会失效。也就是说，<strong>OR前后的两个条件中的列都是索引时，查询中才使用索引</strong>。</p>
<p>因为OR的含义就是两个只要满足一个即可，<code>因此只有一个条伴列进行了索引是没有意义的</code>，只要有条件列没有进行索引，就会进行全表扫描，因此索引的条件列也会失效。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 未使用到索引</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">OR</span> classid <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080043831.png" alt="image-20220628214147368"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 使用到索引</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">OR</span> name <span class="token operator">=</span> <span class="token string">'Abel'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080043312.png" alt="image-20220628214154502"></p>
<h3 id="1-11-数据库和表的字符集统一使用utf8mb4"><a href="#1-11-数据库和表的字符集统一使用utf8mb4" class="headerlink" title="1.11 数据库和表的字符集统一使用utf8mb4"></a><strong>1.11</strong> <strong>数据库和表的字符集统一使用utf8mb4</strong></h3><p>​	统一使用utf8mb4( 5.5.3版本以上支持)兼容性更好，统一字符集可以避免由于字符集转换产生的乱码。不同的<code>字符集</code>进行比较前需要进行<code>转换</code>会造成索引失效。</p>
<h3 id="1-12-练习及一般性建议"><a href="#1-12-练习及一般性建议" class="headerlink" title="1.12 练习及一般性建议"></a>1.12 练习及一般性建议</h3><p><strong>练习</strong>:假设:index(a,b,c)<br><img src="/medias/loading.gif" data-original="/16/%E7%AC%AC10%E7%AB%A0_%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E4%B8%8E%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96.assets/image-20220327001211718.png" alt="image-20220327001211718"></p>
<p><strong>一般性建议:</strong></p>
<ul>
<li>对于单列索引,l尽量选择针对当前query过滤性更好的索引</li>
<li>在选择组合索引的时候，当前query中过滤性最好的字段在索引字段顺序中，位置越靠前越好。。在选择组合</li>
<li>索引的时候，尽量选择能够包含当前query中的where子句中更多字段的索引。</li>
<li>在选择组合索引的时候，如果某个字段可能出现范围查询时，尽量把这个字段放在索引次序的最后面。</li>
</ul>
<p><strong>总之，书写SQL语句时，尽量避免造成索引失效的情况。</strong></p>
<h2 id="2、关联查询优化"><a href="#2、关联查询优化" class="headerlink" title="2、关联查询优化"></a>2、关联查询优化</h2><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">#分类
CREATE TABLE IF NOT EXISTS &#96;type&#96;(
&#96;id&#96; INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
&#96;card&#96; INT(10) UNSIGNED NOT NULL,
PRIMARY KEY ( &#96;id&#96; )
);

#图书
CREATE TABLE IF NOT EXISTS &#96;book&#96;(
	&#96;bookid&#96; INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
    &#96;card&#96;INT(10) UNSIGNED NOT NULL,
	PRIMARY KEY (&#96;bookid&#96;)
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">#向分类表中添加20条记录
INSERT INTO type (card) VALUES (FLOOR(1 +(RAND() * 20)));

#向图书表中添加20条记录
INSERT INTO book(card) VALUES (FLOOR(1 +(RAND() * 20)) );<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="2-1-采用左外连接"><a href="#2-1-采用左外连接" class="headerlink" title="2.1 采用左外连接"></a>2.1 采用左外连接</h3><p>下面开始 EXPLAIN 分析</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080040309.png" alt="image-20220628214944472"></p>
<p>结论：type 有All</p>
<p>添加索引优化</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> book <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> Y <span class="token punctuation">(</span> card<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">--【被驱动表】，可以避免全表扫描</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080040134.png" alt="image-20220628215056882"></p>
<p>可以看到第二行的 type 变为了 ref，rows 也变成了优化比较明显。这是由左连接特性决定的。LEFT JOIN 条件用于确定如何从右表搜索行，左边一定都有，所以 <strong>右边是我们的关键点,一定需要建立索引 。</strong></p>
<blockquote>
<p>如果只能添加一边的索引，，那就给<code>被驱动表</code>添加上索引。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> X <span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">--【驱动表】，无法避免全表扫描</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080040950.png" alt="image-20220628215136764"></p>
<p>接着：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> Y <span class="token keyword">ON</span> book<span class="token punctuation">;</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080039973.png" alt="image-20220628215144196"></p>
<blockquote>
<p>去掉被驱动索引，又变成了 join buffer</p>
</blockquote>
<h3 id="2-2-采用内连接"><a href="#2-2-采用内连接" class="headerlink" title="2.2 采用内连接"></a>2.2 采用内连接</h3><p><strong>前置知识</strong></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080039084.png" alt="image-20220327112700993"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">index</span> X <span class="token keyword">on</span> <span class="token keyword">type</span><span class="token punctuation">;</span>
<span class="token keyword">drop</span> <span class="token keyword">index</span> Y <span class="token keyword">on</span> book<span class="token punctuation">;</span>
<span class="token comment">--（如果已经删除了可以不用再执行该操作）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>换成 inner join（MySQL自动选择驱动表）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">type</span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080039720.png" alt="image-20220628215201873"></p>
<p>添加索引优化</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> book <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> Y <span class="token punctuation">(</span> card<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">type</span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080039516.png" alt="image-20220628215210893"></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080039270.png" alt="image-20220327110718552"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- type 加索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">type</span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> X <span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 观察执行情况</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">type</span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080039128.png" alt="image-20220628215218150"></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080039342.png" alt="image-20220327111114145"></p>
<blockquote>
<p>这里刚给type加了索引后，驱动表和被驱动表还是原来的样子。</p>
<p>给type 继续加了一些数据后优化器会判断，哪个数据比较少。就作为驱动表</p>
</blockquote>
<p><strong>结论：</strong></p>
<ul>
<li><p><code>内连接</code> 主被驱动表是由优化器决定的。优化器认为哪个成本比较小，就采用哪种作为驱动表。</p>
</li>
<li><p>如果两张表只有一个有索引，那有索引的表作为<code>被驱动表</code>。</p>
<ul>
<li>原因：驱动表要全查出来。有没有索引你都得全查出来。</li>
</ul>
</li>
<li><p>两个索引都存在的情况下， 数据量大的 作为<code>被驱动表</code>（小表驱动大表）</p>
<ul>
<li>原因：驱动表要全部查出来，而大表可以通过索引加快查找</li>
</ul>
</li>
</ul>
<p>接着：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> X <span class="token keyword">ON</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TYPE</span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080038048.png" alt="image-20220628215227009"></p>
<p>接着：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> X <span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080039359.png" alt="image-20220628215233583"></p>
<blockquote>
<p>结论1：对于内连接来说，查询优化器可以决定谁来作为驱动表，谁作为被驱动表出现</p>
<p>结论2：对于内连接来讲，如果表的连接条件中只能有一个字段有索引，则有索引的字段所在的表会被作为被驱动表</p>
<p>结论3：对于内连接来说，在两个表的连接条件都存在索引的情况下，会选择小表作为驱动表。<code>小表驱动大表</code></p>
</blockquote>
<h3 id="2-3-join语句原理"><a href="#2-3-join语句原理" class="headerlink" title="2.3 join语句原理"></a>2.3 join语句原理</h3><p>join方式连接多个表，本质就是各个表之间数据的循环匹配。MySQL5.5欣本之刖，MySQL只文持一种表间关联方式，就是嵌套循环(<code>Nested Loop Join</code>)。如果关联表的数据量很大，则join关联的执行时间会非常长。在MySQL5.5以后的版本中，MySQL通过引入<code>BNLJ</code>算法来优化嵌套执行。</p>
<h4 id="1-驱动表和被驱动表"><a href="#1-驱动表和被驱动表" class="headerlink" title="1.驱动表和被驱动表"></a>1.驱动表和被驱动表</h4><p>驱动表就是主表，被驱动表就是从表、非驱动表。</p>
<ul>
<li><p>对于内连接来说:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT * FROM A JOIN B ON ...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>A一定是驱动表吗?不一定，优化器会根据你查询语句做优化，决定先查哪张表。先查询的那张表就是驱动表，反之就是被驱动表。通过explain关键字可以查看。</p>
<ul>
<li><p>对于外连接来说:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT * FROM A LEFT JOIN B ON ...
#或
SELECT *FROM B RIGHT JOIN A ON ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>通常，大家会认为A就是驱动表，B就是被驱动表。但也未必。测试如下:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE TABLE a(f1 INT,f2 INT,INDEX(f1))ENGINE&#x3D;INNODB;

CREATE TABLE b(f1 INT,f2 INT)ENGINE&#x3D;INNODB;

INSERT INTO a VALUES(1,1),(2,2),(3,3),(4,4),(5,5),(6,6);

INSERT INTO b VALUES (3,3),(4,4),(5,5),(6,6),(7,7),(8,8);

#测试1
EXPLAIN SELECT* FROM a LEFT JOIN b ON (a.f1&#x3D;b.f1)WHERE (a.f2&#x3D;b.f2);

#测试2
EXPLAIN SELECT * FROM a LEFT JOIN b oN (a.f1&#x3D;b.f1) AND (a.f2&#x3D;b.f2);
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>测试1结果：</strong></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080038766.png" alt="image-20220327113715776"></p>
<p>得出这种结论太不可思议了，跟上一个show warnings 看看：</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080038739.png" alt="image-20220327114615193"></p>
<p><strong>测试2结果：</strong></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080038454.png" alt="image-20220327113840201"></p>
<p>继续show warnings \G</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080038374.png" alt="image-20220327114721018"></p>
</li>
</ul>
</li>
</ul>
<h4 id="2-Simple-Nested-Loop-Join-简单嵌套循环连接"><a href="#2-Simple-Nested-Loop-Join-简单嵌套循环连接" class="headerlink" title="2 Simple Nested-Loop Join(简单嵌套循环连接)"></a>2 Simple Nested-Loop Join(简单嵌套循环连接)</h4><p>算法相当简单，从表A中取出一条数据1，遍历表B，将匹配到的数据放到result..以此类推，驱动表A中的每一条记录与被驱动表B的记录进行判断:</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080038160.png" alt="image-20220327115112379"></p>
<p>这个例子是在没有索引的情况，做了全表扫描</p>
<p>可以看到这种方式效率是非常低的，以上述表A数据100条，表B数据1000条计算，则A*B&#x3D;10万次。开销统计如下:</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080038473.png" alt="image-20220327115215270"></p>
<p>当然mysql肯定不会这么粗暴的去进行表的连接，所以就出现了后面的两种对Nested-Loop Join优化算法。</p>
<h4 id="3-Index-Nested-Loop-Join（索引嵌套循环连接）"><a href="#3-Index-Nested-Loop-Join（索引嵌套循环连接）" class="headerlink" title="3 Index Nested-Loop Join（索引嵌套循环连接）"></a>3 Index Nested-Loop Join（索引嵌套循环连接）</h4><p>​	Index Nested-Loop Join其优化的思路主要是为了<code>减少内层表数据的匹配次数</code>，所以要求被驱动表上必须<code>有索引</code>才行。通过外层表匹配条件直接与内层表索引进行匹配，避免和内层表的每条记录去进行比较，这样极大的减少了对内层表的匹配次数。</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080038776.png" alt="image-20220401182649509"></p>
<p>驱动表中的每条记录通过被驱动表的索引进行访问，因为索引查询的成本是比较固定的，故mysql优化器都倾向于使用记录数少的表作为驱动表(外表)。</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080038915.png" alt="image-20220327120030338"></p>
<p>如果被驱动表加索引，效率是非常高的，但如果索引不是主键索引，所以还得进行一次回表查询。相比，被驱动表的索引是主键索引，效率会更高。</p>
<p>我们来看一下这个语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t1 STRAIGHT_JOIN t2 <span class="token keyword">ON</span> <span class="token punctuation">(</span>t1<span class="token punctuation">.</span>a<span class="token operator">=</span>t2<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>​	如果直接使用join语句，MySQL优化器可能会选择表t1或t2作为驱动表，这样会影响我们分析SQL语句的执行过程。所以，为了便于分析执行过程中的性能问题，我改用 straight_join 让MySQL使用固定的连接方式执行查询，这样优化器只会按照我们指定的方式去join。在这个语句里，t1 是驱动表，t2是被驱动表。</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080037805.png" alt="image-20220628220010623"></p>
<p>​	可以看到，在这条语句里，被驱动表t2的字段a上有索引，join过程用上了这个索引，因此这个语句的执 行流程是这样的：</p>
<ol>
<li>从表t1中读入一行数据 R； </li>
<li>从数据行R中，取出a字段到表t2里去查找； </li>
<li>取出表t2中满足条件的行，跟R组成一行，作为结果集的一部分； </li>
<li>重复执行步骤1到3，直到表t1的末尾循环结束。</li>
</ol>
<p>​	这个过程是先遍历表t1，然后根据从表t1中取出的每行数据中的a值，去表t2中查找满足条件的记录。在 形式上，这个过程就跟我们写程序时的嵌套查询类似，并且可以用上被驱动表的索引，所以我们称之为 “Index Nested-Loop Join”，简称NLJ。</p>
<p>它对应的流程图如下所示：</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080037869.png" alt="image-20220628220019109"></p>
<p>在这个流程里： </p>
<ol>
<li>对驱动表t1做了全表扫描，这个过程需要扫描100行； </li>
<li>而对于每一行R，根据a字段去表t2查找，走的是树搜索过程。由于我们构造的数据都是一一对应 的，因此每次的搜索过程都只扫描一行，也是总共扫描100行； </li>
<li>所以，整个执行流程，总扫描行数是200。</li>
</ol>
<p>&#x3D;&#x3D;引申问题1：能不能使用join?&#x3D;&#x3D;</p>
<p>&#x3D;&#x3D;引申问题2：怎么选择驱动表？&#x3D;&#x3D;</p>
<blockquote>
<p>比如：N扩大1000倍的话，扫描行数就会扩大1000倍；而M扩大1000倍，扫描行数扩大不到10倍。</p>
</blockquote>
<blockquote>
<p>两个结论： 1. 使用join语句，性能比强行拆成多个单表执行SQL语句的性能要好； 2. 如果使用join语句的话，需要让小表做驱动表。</p>
</blockquote>
<h4 id="4-Block-Nested-Loop-Join（块嵌套循环连接）"><a href="#4-Block-Nested-Loop-Join（块嵌套循环连接）" class="headerlink" title="4 Block Nested-Loop Join（块嵌套循环连接）"></a>4 Block Nested-Loop Join（块嵌套循环连接）</h4><p>​	如果存在索引，那么会使用index的方式进行join，如果join的列没有索引，被驱动表要扫描的次数太多了。每次访问被驱动表，其表中的记录都会被加载到内存中，然后再从驱动表中取一条与其匹配，匹配结束后清除内存，然后再从驱动表中加载一条记录，然后把被驱动表的记录再加载到内存匹配，这样周而复始，大大增加了IO的次数。为了减少被驱动表的IO次数，就出现了Block Nested-Loop Join的方式。</p>
<p>​	不再是逐条获取驱动表的数据，而是一块一块的获取，引入了<code>join buffer缓冲区</code>，将驱动表join相关的部分数据列（大小受join buffer的限制）缓存到join buffer中，然后全表扫描被驱动表，被驱动表的每一条记录一次性和join buffer中的所有驱动表记录进行匹配（内存中操作），将简单嵌套循环中的多次比较合并成一次，降低了被驱动表的访问频率。</p>
<blockquote>
<p>注意:</p>
<p>这里缓存的不只是关联表的列, select后面的列也会缓存起来。<strong>（存的是驱动表）</strong></p>
<p>在一个有N个join关联的sql中会分配N-1个join buffer。所以查询的时候尽量减少不必要的字段，可以让joinbuffer中可以存放更多的列。</p>
</blockquote>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080037332.png" alt="image-20220401183344880"></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080037749.png" alt="image-20220327144009591"></p>
<p>参数设置：</p>
<ul>
<li><p>block_nested_loop</p>
<p>通过<code>show variables like &#39;%optimizer_switch%&#39;</code>查看<code>block_nested_loop</code>状态。默认是开启的。. - - </p>
</li>
<li><p>join_buffer_size</p>
<p>驱动表能不能一次加载完，要看join buffer能不能存储所有的数据，默认情况下<code>join_buffer_size=256k</code>。</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; show variables like &#39;%join_buffer%&#39;;
+------------------+--------+
| Variable_name    | Value  |
+------------------+--------+
| join_buffer_size | 262144 |
+------------------+--------+
1 row in set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>join_buffer_size的最大值在32位系统可以电请4G，而在64位操做系统下可以申请大于4G的Join Buffer空间(64位Windows除外，其大值会被截断为4GB并发出警告)。</p>
</li>
</ul>
<p>这个过程的流程图如下：</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080037462.png" alt="image-20220628220044759"></p>
<p>执行流程图也就变成这样：</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080037998.png" alt="image-20220628220054492"></p>
<p>&#x3D;&#x3D;总结1：能不能使用xxx join语句？&#x3D;&#x3D; </p>
<p>&#x3D;&#x3D;总结2：如果要使用join，应该选择大表做驱动表还是选择小表做驱动表？&#x3D;&#x3D; </p>
<p>&#x3D;&#x3D;总结3：什么叫作“小表”？&#x3D;&#x3D; </p>
<p>​	在决定哪个表做驱动表的时候，应该是两个表按照各自的条件过滤，过滤完成之后，计算参与join的各 个字段的总数据量，数据量小的那个表，就是“小表”，应该作为驱动表。</p>
<h4 id="5-Join小结"><a href="#5-Join小结" class="headerlink" title="5.Join小结"></a>5.Join小结</h4><p>1、<strong>整体效率比较:INLJ &gt; BNLJ &gt; SNLJ</strong></p>
<p>2、永远用小结果集驱动大结果集(其本质就是减少外层循环的数据数量)(小的度量单位指的是表行数*每行大小)</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql"># straight_join 不然优化器优化谁是驱动表  驱动表 straight_join 被驱动表
# 这个例子是说t2 的列比较多，，相同的join buffer 加的会比较少。所以不适合用t2 作为  ！！！驱动表
select t1.b,t2.* from t1 straight_join t2 on (t1.b&#x3D;t2.b) where t2.id&lt;&#x3D;180;#推荐

select t1.b,t2.* from t2 straight_join t1 on (t1.b&#x3D;t2.b) where t2.id&lt;&#x3D;100;#不推荐<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3、为被驱动表匹配的条件增加索引(减少内层表的循环匹配次数)</p>
<p>4、增大join buffer size的大小(一次缓存的数据越多，那么内层包的扫表次数就越少)</p>
<p>5、减少<code>驱动表</code>不必要的字段查询（字段越少，join buffer 所缓存的数据就越多)</p>
<p>6、在决定哪个表做驱动表的时候，应该是两个表按照各自的条件过滤，过滤完成之后，计算参与join的各个字段的总数据量，数据量小的那个表，就是“小表”，应该作为驱动表。</p>
<h3 id="2-3-小结"><a href="#2-3-小结" class="headerlink" title="2.3 小结"></a>2.3 小结</h3><ul>
<li>保证被驱动表的JOIN字段已经创建了索引 </li>
<li>需要JOIN 的字段，数据类型保持绝对一致。 </li>
<li>LEFT JOIN 时，选择小表作为驱动表， 大表作为被驱动表 。减少外层循环的次数。 </li>
<li>INNER JOIN 时，MySQL会自动将 小结果集的表选为驱动表 。选择相信MySQL优化策略。 </li>
<li>能够直接多表关联的尽量直接关联，不用子查询。(减少查询的趟数) </li>
<li>不建议使用子查询，建议将子查询SQL拆开结合程序多次查询，或使用 JOIN 来代替子查询。 </li>
<li>衍生表建不了索引</li>
</ul>
<h3 id="2-4-Hash-Join"><a href="#2-4-Hash-Join" class="headerlink" title="2.4 Hash Join"></a>2.4 Hash Join</h3><p><strong>从MySQL的8.0.20版本开始将废弃BNLJ，因为从MySQL8.0.18版本开始就加入了hash join默认都会使用hash join</strong></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080037127.png" alt="image-20220327151158056"></p>
<ul>
<li>Nested Loop：对于被连接的数据子集较小的情况下，Nested Loop是个较好的选择。</li>
<li>Hash Join是做<code>大数据集连接</code>时的常用方式，优化器使用两个表中较小（相对较小）的表利用Join Key在内存中建立<code>散列值</code>，然后扫描较大的表并探测散列值，找出与Hash表匹配的行。<ul>
<li>这种方式适用于较小的表完全可以放入内存中的情况，这样总成本就是访问两个表的成本之和。</li>
<li>在表很大的情况下并不能完全放入内存，这时优化器会将它分割成<code>若干不同的分区</code>，不能放入内存的部分就把该分区写入磁盘的临时段，此时要求有较大的临时段从而尽量提高I&#x2F;O的性能。</li>
<li>它能够很好的工作于没有索引的大表和并行查询的环境中，并提供最好的性能。Hash Join只能应用于等值连接，这是由Hash的特点决定的。</li>
</ul>
</li>
</ul>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080037238.png" alt="image-20220327151646951"></p>
<h2 id="3、子查询优化"><a href="#3、子查询优化" class="headerlink" title="3、子查询优化"></a>3、子查询优化</h2><p>​	MySQL从4.1版本开始支持子查询，使用子查询可以进行SELECT语句的嵌套查询，即一个SELECT查询的结 果作为另一个SELECT语句的条件。 <strong>子查询可以一次性完成很多逻辑上需要多个步骤才能完成的SQL操作 。</strong></p>
<p>​	<strong>子查询是</strong> <strong>MySQL</strong> <strong>的一项重要的功能，可以帮助我们通过一个</strong> <strong>SQL</strong> <strong>语句实现比较复杂的查询。但是，子查询的执行效率不高。</strong>原因：</p>
<p>① 执行子查询时，MySQL需要为内层查询语句的查询结果<code>建立一个临时表</code>，然后外层查询语句从临时表中查询记录。查询完毕后，再<code>撤销这些临时表</code>。这样会消耗过多的CPU和IO资源，产生大量的慢查询。</p>
<p>② 子查询的结果集存储的临时表，不论是内存临时表还是磁盘临时表都<code>不会存在索引</code>，所以查询性能会受到一定的影响。</p>
<p>③ 对于返回结果集比较大的子查询，其对查询性能的影响也就越大。</p>
<p>​	<strong>在MySQL中，可以使用连接（JOIN）查询来替代子查询。</strong>连接查询<code>不需要建立临时表</code>，其<code>速度比子查询要快</code>，如果查询中使用索引的话，性能就会更好。</p>
<p>举例1:查询学生表中是班长的学生信息</p>
<ul>
<li><p>使用子查询</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">#创建班级表中班长的索引
CREATE INDEX idx_monitor ON class ( monitor ) ;
EXPLAIN SELECT *FROM student stu1
WHERE stu1 . &#39;stuno&#96;IN(
SELECT monitor
FROM class c
WHERE monitor IS NOT NULL);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>推荐:使用多表查询</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT stu1.* FROM student stu1 JOIN class c
ON stu1 . &#39;stuno&#96; &#x3D; c. &#39;monitor&#39;
WHERE c. &#39;monitor&#96; IS NOT NULL;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p>举例2:取所有不为班长的同学·不推荐</p>
<ul>
<li><p>子查询</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT SQL_NO_CACHE a.* FROM student a
WHERE a.stuno NOT IN (
SELECT monitor FROM class bWHERE monitor IS NOT NULL);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>修改成多表查询</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT SQL_NO_CACHE a.*
FROM student a LEFT OUTER JOIN class b ON a. stuno &#x3D;b.monitor
WHERE b.monitor IS NULL;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ul>
<blockquote>
<p>结论：尽量不要使用NOT IN 或者 NOT EXISTS，用LEFT JOIN xxx ON xx WHERE xx IS NULL替代</p>
</blockquote>
<h2 id="4、排序优化"><a href="#4、排序优化" class="headerlink" title="4、排序优化"></a>4、排序优化</h2><h3 id="4-1-排序优化"><a href="#4-1-排序优化" class="headerlink" title="4.1 排序优化"></a>4.1 排序优化</h3><p>&#x3D;&#x3D;问题：&#x3D;&#x3D;在 WHERE 条件字段上加索引，但是为什么在 ORDER BY 字段上还要加索引呢？</p>
<p><strong>回答:</strong></p>
<p>在MySQL中，支持两种排序方式，分别是<code>FileSort</code>和<code>Index</code>排序。</p>
<ul>
<li>Index排序中，索引可以保证数据的有序性，不需要再进行排序，<code>效率更高</code>。</li>
<li>FileSort排序则一般在<code>内存中</code>进行排序，占用<code>CPU较多</code>。如果待排结果较大，会产生临时文件I&#x2F;O到磁盘进行排序的情况，效率较低。</li>
</ul>
<p>&#x3D;&#x3D;优化建议：&#x3D;&#x3D;</p>
<ol>
<li>SQL 中，可以在 WHERE 子句和 ORDER BY 子句中使用索引，目的是在 WHERE 子句中 <code>避免全表扫描</code>，在 ORDER BY 子句<code>避免使用 FileSort 排序</code>。当然，某些情况下全表扫描，或者 FileSort 排序不一定比索引慢。但总的来说，我们还是要避免，以提高查询效率。</li>
<li>尽量使用 Index 完成 ORDER BY 排序。如果 WHERE 和 ORDER BY 后面是相同的列就使用单索引列；如果不同就使用联合索引。</li>
<li>无法使用 Index 时，需要对 FileSort 方式进行调优。</li>
</ol>
<h3 id="4-2测试"><a href="#4-2测试" class="headerlink" title="4.2测试"></a>4.2测试</h3><p>删除student表和class表中已创建的索引。</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">#方式1:
DROP INDEX idx_monitor ON class;

DROP INDEX idx_cid ON student;
DROP INDEX idx_age ON student;DROP INDEX idx_name ON student ;
DROP INDEX idx_age_name_classid ON student ;DROP INDEX idx_age_classid_name ON student ;

#方式2:
call proc_drop_index( &#39; atguigudb2&#39; , &#39;student&#39; );<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以下是否能使用到索引，能否去掉<code>using filesort</code></p>
<p><strong>过程一:</strong></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT SQL_NO_CACHE * FROM student ORDER BY age,classid;

EXPLAIN SELECT SQL_NO_CACHE * FROM student ORDER BY age,classid limit 10;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080036486.png" alt="image-20220327154029455"></p>
<p><strong>过程二: order by时不limit，索引失效</strong></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">#创建索引
CREATE INDEX idx_age_classid_name ON student (age,classid, NAME);
#不限制,索引失效
EXPLAIN SELECT SQL_NO_CACHE * FROM student ORDER BY age ,classid ;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080036693.png" alt="image-20220327154234022"></p>
<blockquote>
<p>这里优化器觉得，，还需要回表。会费时间更大，不走索引。</p>
</blockquote>
<p>使用覆盖索引试试看</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080036540.png" alt="image-20220327154426669"></p>
<blockquote>
<p>不用回表，优化器觉得走索引快。就使用了索引。</p>
</blockquote>
<p>增加limit 条件</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080036655.png" alt="image-20220327154631330"></p>
<blockquote>
<p>增加limit 减少回表的数量，优化器觉得走索引快，会使用索引</p>
</blockquote>
<p><strong>过程三: order by时顺序错误，索引失效</strong></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE INDEX idx_age_classid_stuno ON student (age,classid,stuno) ;

#以下哪些索引失效?

# 不会走，最左前缀原则
EXPLAIN SELECT* FROM student ORDER BY classid LIMIT 10;

# 不会走，最左前缀原则
EXPLAIN SELECT* FROM student ORDER BY classid,NAME LIMIT 10;

# 走
EXPLAIN SELECT* FROM student ORDER BY age,classid, stuno LIMIT 10;
# 走
EXPLAIN SELECT *FROM student ORDER BY age,classid LIMIT 10;
# 走
EXPLAIN SELECT * FROM student ORDER BY age LIMIT 10;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>过程四: order by时规则不一致,索引失效（顺序错，不索引; 方向反，不索引)</strong></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql"># age desc 方向反 索引失效
EXPLAIN SELECT * FROM student ORDER BY age DESC, classid ASC LIMIT 10;

# 没有最左前缀 索引失效
EXPLAIN SELECT * FROM student ORDER BY classid DESC, NAME DESC LIMIT 10;

# age asc 没问题 classid desc 降序， 优化器认为，文件排序比较快索引失效
# 方向反了不走索引
EXPLAIN SELECT * FROM student ORDER BY age ASC, classid DESC LIMIT 10;

# Backward index scan 走索引了，，倒着走索引
EXPLAIN SELECT * FROM student ORDER BY age DESC, classid DESC LIMIT 10; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><strong>过程五:无过滤,不索引</strong></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT * FROM student WHERE age&#x3D;45 ORDER BY classid;

EXPLAIN SELECT * FROM student WHERE age&#x3D;45 ORDER BY classid , name;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080036027.png" alt="image-20220327163331675"></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT *FROM student WHERE classid&#x3D;45 order by age;

EXPLAIN SELECT * FROM student WHERE classid&#x3D;45 order by age limit 10;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080036917.png" alt="image-20220327163436260"></p>
<p>这里第一条排序走Using filesort 很好理解</p>
<p>第二条为啥不是 <code>Using filesort </code> 呢？</p>
<p>这里type &#x3D; index，key&#x3D;idx_age_classid_name 。 这说明了 优化器预估对idx_age_classid_name  索引进行完整的遍历。由于索引本身就是根据age升序存储的。。所以只要在遍历的过程中，遇到前十个classid&#x3D;45。就可以停止遍历。回表返回数据。（根据上完课自己想的，无法验证，不知道有没有偏差）</p>
<p><strong>小结:</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INDEX</span> a_b_c<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span>

<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token comment">-- 能使用索引最左前缀</span>
<span class="token operator">-</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a
<span class="token operator">-</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">,</span>b
<span class="token operator">-</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c
<span class="token operator">-</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a <span class="token keyword">DESC</span><span class="token punctuation">,</span>b <span class="token keyword">DESC</span><span class="token punctuation">,</span>c <span class="token keyword">DESC</span>

<span class="token comment">-- 如果WHERE使用索引的最左前缀定义为常量，则order by 能使用索引</span>
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> b<span class="token punctuation">,</span>c
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token operator">AND</span> b <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> b<span class="token punctuation">,</span>c
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token operator">AND</span> b <span class="token operator">></span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> b<span class="token punctuation">,</span>c

<span class="token comment">-- 不能使用索引进行排序</span>
<span class="token operator">-</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a <span class="token keyword">ASC</span><span class="token punctuation">,</span>b <span class="token keyword">DESC</span><span class="token punctuation">,</span>c <span class="token keyword">DESC</span> <span class="token comment">/* 排序不一致 */</span>
<span class="token operator">-</span> <span class="token keyword">WHERE</span> g <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> b<span class="token punctuation">,</span>c <span class="token comment">/*丢失a索引*/</span>
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c <span class="token comment">/*丢失b索引*/</span>
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">,</span>d <span class="token comment">/*d不是索引的一部分*/</span>
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> b<span class="token punctuation">,</span>c <span class="token comment">/*对于排序来说，多个相等条件也是范围查询*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>索引只会用到一个，没办法一个索引用来where 一个索引用来 order by。</p>
<p>但是可以建立联合索引。</p>
</blockquote>
<h3 id="4-2-案例实战"><a href="#4-2-案例实战" class="headerlink" title="4.2 案例实战"></a>4.2 案例实战</h3><p>ORDER BY子句，尽量使用Index方式排序，避免使用FileSort方式排序。 </p>
<p>执行案例前先清除student上的索引，只留主键：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age <span class="token keyword">ON</span> student<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_classid_stuno <span class="token keyword">ON</span> student<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_classid_name <span class="token keyword">ON</span> student<span class="token punctuation">;</span>

<span class="token comment">-- 或者</span>
<span class="token keyword">call</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">'atguigudb2'</span><span class="token punctuation">,</span><span class="token string">'student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>场景:查询年龄为30岁的，且学生编号小于101000的学生，按用户名称排序</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> stuno <span class="token operator">&lt;</span><span class="token number">101000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> NAME <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080036054.png" alt="image-20220628221533732"></p>
<p>查询结果如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> stuno <span class="token operator">&lt;</span><span class="token number">101000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
NAME <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------+--------+--------+------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> stuno <span class="token operator">|</span> name <span class="token operator">|</span> age <span class="token operator">|</span> classId <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+--------+--------+------+---------+</span>
<span class="token operator">|</span> <span class="token number">922</span> <span class="token operator">|</span> <span class="token number">100923</span> <span class="token operator">|</span> elTLXD <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">249</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3723263</span> <span class="token operator">|</span> <span class="token number">100412</span> <span class="token operator">|</span> hKcjLb <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">59</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3724152</span> <span class="token operator">|</span> <span class="token number">100827</span> <span class="token operator">|</span> iHLJmh <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">387</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3724030</span> <span class="token operator">|</span> <span class="token number">100776</span> <span class="token operator">|</span> LgxWoD <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">253</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">100031</span> <span class="token operator">|</span> LZMOIa <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">97</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3722887</span> <span class="token operator">|</span> <span class="token number">100237</span> <span class="token operator">|</span> QzbJdx <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">440</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">609</span> <span class="token operator">|</span> <span class="token number">100610</span> <span class="token operator">|</span> vbRimN <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">481</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">139</span> <span class="token operator">|</span> <span class="token number">100140</span> <span class="token operator">|</span> ZqFbuR <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">351</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+--------+--------+------+---------+</span>
<span class="token number">8</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">3.16</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>结论：type 是 ALL，即最坏的情况。Extra 里还出现了 Using filesort,也是最坏的情况。优化是必须 的。</p>
</blockquote>
<p>优化思路：</p>
<p>方案一: 为了去掉filesort我们可以把索引建成</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#创建新索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_name <span class="token keyword">ON</span> student<span class="token punctuation">(</span>age <span class="token punctuation">,</span> NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> stuno <span class="token operator">&lt;</span><span class="token number">101000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> NAME<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080035906.png" alt="image-20220327171114961"></p>
<p>方案二: 尽量让where的过滤条件和排序使用上索引</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">index</span> idx_age_stuno_name <span class="token keyword">on</span> student<span class="token punctuation">(</span>age<span class="token punctuation">,</span>stuno<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> stuno <span class="token operator">&lt;</span><span class="token number">101000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> NAME<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080035944.png" alt="image-20220327171516492"></p>
<p>下面这个方案虽然使用了<code> Using filesort</code> 但是速度反而更快了。</p>
<p>原因:</p>
<p>所有的排序都是在条件过滤之后才执行的。所以，如果条件过滤掉大部分数据的话，剩下几百几千条数据进行排序其实并不是很消耗性能，即使索引优化了排序，但实际提升性能很有限。相对的stuno&lt;101000这个条件，如果没有用到索引的话，要对几万条的数据进行扫描，这是非常消耗性能的，所以索引放在这个字段上性价比最高，是最优选择。</p>
<blockquote>
<p>结论:<br>1．两个索引同时存在，mysql自动选择最优的方案。(对于这个例子mysql选择idx_age_stuno_name)。但是，<code>随着数据量的变化，选择的索引也会随之变化的。</code></p>
<p>2.<strong>当【范围条件】和【group by或者order by】的字段出现二选一时，优先观察条件字段的过滤数量，如<br>果过滤的数据足够多，而需要排序的数据并不多时，优先把索引放在范围字段上。反之，亦然。</strong></p>
</blockquote>
<p>思考:这里我们使用如下索引，是否可行?</p>
<p>建一个三个字段的组合索引：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_name <span class="token keyword">ON</span> student<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_stuno_name <span class="token keyword">ON</span> student <span class="token punctuation">(</span>age<span class="token punctuation">,</span>stuno<span class="token punctuation">,</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> stuno <span class="token operator">&lt;</span><span class="token number">101000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> NAME <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student
<span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> stuno <span class="token operator">&lt;</span><span class="token number">101000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> NAME <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----+--------+--------+------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> stuno <span class="token operator">|</span> name <span class="token operator">|</span> age <span class="token operator">|</span> classId <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----+--------+--------+------+---------+</span>
<span class="token operator">|</span> <span class="token number">167</span> <span class="token operator">|</span> <span class="token number">100168</span> <span class="token operator">|</span> AClxEF <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">319</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">323</span> <span class="token operator">|</span> <span class="token number">100324</span> <span class="token operator">|</span> bwbTpQ <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">654</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">651</span> <span class="token operator">|</span> <span class="token number">100652</span> <span class="token operator">|</span> DRwIac <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">997</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">517</span> <span class="token operator">|</span> <span class="token number">100518</span> <span class="token operator">|</span> HNSYqJ <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">256</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">344</span> <span class="token operator">|</span> <span class="token number">100345</span> <span class="token operator">|</span> JuepiX <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">329</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">905</span> <span class="token operator">|</span> <span class="token number">100906</span> <span class="token operator">|</span> JuWALd <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">892</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">574</span> <span class="token operator">|</span> <span class="token number">100575</span> <span class="token operator">|</span> kbyqjX <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">260</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">703</span> <span class="token operator">|</span> <span class="token number">100704</span> <span class="token operator">|</span> KJbprS <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">594</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">723</span> <span class="token operator">|</span> <span class="token number">100724</span> <span class="token operator">|</span> OTdJkY <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">236</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">656</span> <span class="token operator">|</span> <span class="token number">100657</span> <span class="token operator">|</span> Pfgqmj <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">600</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">982</span> <span class="token operator">|</span> <span class="token number">100983</span> <span class="token operator">|</span> qywLqw <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">837</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">468</span> <span class="token operator">|</span> <span class="token number">100469</span> <span class="token operator">|</span> sLEKQW <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">346</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">988</span> <span class="token operator">|</span> <span class="token number">100989</span> <span class="token operator">|</span> UBYqJl <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">457</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">173</span> <span class="token operator">|</span> <span class="token number">100174</span> <span class="token operator">|</span> UltkTN <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">830</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">332</span> <span class="token operator">|</span> <span class="token number">100333</span> <span class="token operator">|</span> YjWiZw <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">824</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----+--------+--------+------+---------+</span>
<span class="token number">15</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	结果竟然有 filesort的 sql 运行速度， 超过了已经优化掉 filesort的 sql ，而且快了很多，几乎一瞬间 就出现了结果。</p>
<p>&#x3D;&#x3D;结论：&#x3D;&#x3D; </p>
<ol>
<li>两个索引同时存在，mysql自动选择最优的方案。（对于这个例子，mysql选择 idx_age_stuno_name）。但是， <strong>随着数据量的变化，选择的索引也会随之变化的</strong> 。</li>
<li><strong>当【范围条件】和【group by 或者 order by】的字段出现二选一时，优先观察条件字段的过 滤数量，如果过滤的数据足够多，而需要排序的数据并不多时，优先把索引放在范围字段 上。反之，亦然。</strong></li>
</ol>
<p>思考：这里我们使用如下索引，是否可行？</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_stuno_name <span class="token keyword">ON</span> student<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_stuno <span class="token keyword">ON</span> student<span class="token punctuation">(</span>age<span class="token punctuation">,</span>stuno<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h3 id="4-3-filesort算法：双路排序和单路排序"><a href="#4-3-filesort算法：双路排序和单路排序" class="headerlink" title="4.3 filesort算法：双路排序和单路排序"></a>4.3 filesort算法：双路排序和单路排序</h3><h4 id="双路排序-（慢）"><a href="#双路排序-（慢）" class="headerlink" title="双路排序 （慢）"></a>双路排序 （慢）</h4><ul>
<li><strong>MySQL 4.1之前是使用双路排序</strong> ，字面意思就是两次扫描磁盘，最终得到数据， 读取行指针和 <strong>order by列</strong> ，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取 对应的数据输出 </li>
<li>从磁盘取排序字段，在buffer进行排序，再从 <strong>磁盘取其他字段</strong> 。</li>
</ul>
<p>​	取一批数据，要对磁盘进行两次扫描，众所周知，IO是很耗时的，所以在mysql4.1之后，出现了第二种改进的算法，就是单路排序。</p>
<h4 id="单路排序-（快）"><a href="#单路排序-（快）" class="headerlink" title="单路排序 （快）"></a>单路排序 （快）</h4><p>​	从磁盘读取查询需要的 <strong>所有列</strong> ，按照order by列在buffer对它们进行排序，然后扫描排序后的列表进行输 出， 它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO，但是它会使用更多的空 间， 因为它把每一行都保存在内存中了。</p>
<h4 id="结论及引申出的问题"><a href="#结论及引申出的问题" class="headerlink" title="结论及引申出的问题"></a>结论及引申出的问题</h4><ul>
<li>由于单路是后出的，总体而言好过双路 </li>
<li>但是用单路有问题<ul>
<li>在sort_buffer中，单路比多路要<code>多占用更多空间</code>，因为单路是把所有字段都取出,所以有可能取出的数据的总大小超出了<code>sort_buffer</code>的容量，导致每次只能取<code>sort_buffer</code>容量大小的数据，进行排序〈创建tmp文件，多路合并)，排完再取sort_buffer容量大小，再排……从而多次I&#x2F;O。</li>
<li>单路本来想省一次I&#x2F;o操作，<code>反而导致了大量的I/0操作</code>，反而得不偿失。</li>
</ul>
</li>
</ul>
<h4 id="优化策略"><a href="#优化策略" class="headerlink" title="优化策略"></a>优化策略</h4><p><strong>1.尝试提高sort_buffer_size</strong></p>
<ul>
<li><p>不管用哪种算法，提高这个参数都会提高效率，要根据系统的能力去提高，因为这个参数是针对每个进程<br>(connection)的1M-8M之间调整。MySQL5.7，InnoDB存储引擎默认值是1048576字节，1MB。</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; SHOW VARIABLES LIKE &#39;%sort_buffer_size%&#39;;
+-------------------------+---------+
| Variable_name           | Value   |
+-------------------------+---------+
| innodb_sort_buffer_size | 1048576 |
| myisam_sort_buffer_size | 8388608 |
| sort_buffer_size        | 262144  |
+-------------------------+---------+
3 rows in set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p><strong>2尝试提高max_length_for_sort_data</strong></p>
<ul>
<li><p>提高这个参数，会增加用改进算法的概率。</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; SHow VARIABLES LIKE &#39;%max_length_for_sort_data%&#39;;
+--------------------------+-------+
| Variable_name            | Value |
+--------------------------+-------+
| max_length_for_sort_data | 4096  |
+--------------------------+-------+
1 row in set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</li>
<li><p>但是如果设的太高，数据总容量超出<code>sort_buffer_size</code>的概率就增大，明显症状是高的磁盘I&#x2F;o活动和低的处理器使用率。如果需要返回的列的总长度大于<code>max_length_for_sort_data</code>使用<code>双路算法</code>，否则使用单路算法。1024-8192字节之间调整</p>
</li>
</ul>
<p><strong>3.Order by时select*是一个大忌。最好只Query需要的字段。</strong>原因:</p>
<ul>
<li>当Query的字段大小总和小于<code>max_length_for_sort_data</code>，而且排序字段不是TEXT|BLOB类型时，会用改进后的算法――单路排序，否则用老算法――多路排序。</li>
<li>两种算法的数据都有可能超出sort_buffer_size的容量，超出之后，会创建tmp文件进行合并排序，导致多次I&#x2F;o，但是用单路排序算法的风险会更大一些，所以要提高<code>sort_buffer_size</code>。</li>
</ul>
<h2 id="5、GROUP-BY优化"><a href="#5、GROUP-BY优化" class="headerlink" title="5、GROUP BY优化"></a>5、GROUP BY优化</h2><ul>
<li>group by 使用索引的原则几乎跟order by一致 ，group by 即使没有过滤条件用到索引，也可以直接使用索引。</li>
<li>group by 先排序再分组，遵照索引建的最佳左前缀法则</li>
<li>当无法使用索引列，可以增大<code>max_length_for_sort_data</code>和<code>sort_buffer_size</code>参数的设置</li>
<li>where效率高于having，能写在where限定的条件就不要写在having中了</li>
<li>减少使用order by，和业务沟通能不排序就不排序，或将排序放到程序端去做。Order by、group by、distinct这些语句较为耗费CPU，数据库的CPU资源是极其宝贵的。</li>
<li>包含了order by、group by、distinct这些查询的语句，where条件过滤出来的结果集请保持在1000行以内，否则SQL会很慢。</li>
</ul>
<h2 id="6、优化分页查询"><a href="#6、优化分页查询" class="headerlink" title="6、优化分页查询"></a>6、优化分页查询</h2><p>一般分页查询时，通过创建覆盖索引能够比较好地提高性能。一个常见又非常头疼的问题就是limit 2000000,10，此时需要MySQL排序前2000010记录，仅仅返回2000000 - 2000010的记录，其他记录丢弃，查询排序的代价非常大。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">LIMIT</span> <span class="token number">2088800</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p><strong>优化思路一</strong></p>
<p>在索引上完成排序分页操作，最后根据主键关联回原表查询所需要的其他列内容。</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT * FROM student t,(SELECT id FROM student ORDER BY id LIMIT 2000000,10) a WHERE t.id &#x3D; a.id;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080035404.png" alt="image-20220628222026595"></p>
<p><strong>优化思路二(几乎没法用)</strong></p>
<p>该方案适用于主键自增的表，可以把Limit 查询转换成某个位置的查询。</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT * FROM student WHERE id &gt; 2000000 LIMIT 10;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080035395.png" alt="image-20220628222033979"></p>
<blockquote>
<p>不靠谱，生产中id可能会删除，查询的条件也不可能这么简单。</p>
</blockquote>
<h2 id="7、优先考虑覆盖索引"><a href="#7、优先考虑覆盖索引" class="headerlink" title="7、优先考虑覆盖索引"></a>7、优先考虑覆盖索引</h2><h3 id="7-1-什么是覆盖索引？"><a href="#7-1-什么是覆盖索引？" class="headerlink" title="7.1 什么是覆盖索引？"></a>7.1 什么是覆盖索引？</h3><p><strong>理解方式一</strong>：索引是高效找到行的一个方法，但是一般数据库也能使用索引找到一个列的数据，因此它不必读取整个行。毕竟索引叶子节点存储了它们索引的数据；当能通过读取索引就可以得到想要的数据，那就不需要读取行了。<strong>一个索引包含了满足查询结果的数据就叫做覆盖索引。</strong></p>
<p><strong>理解方式二</strong>：非聚簇复合索引的一种形式，它包括在查询里的SELECT、JOIN和WHERE子句用到的所有列（即建索引的字段正好是覆盖查询条件中所涉及的字段）。</p>
<p>简单说就是，<code>索引列+主键</code>包含<code>SELECT 到 FROM之间查询的列</code>。</p>
<p>**举例一:**覆盖索引长什么样子。 <code>索引列+主键</code></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">#斯降之前的索引
DROP INDEX idx_age_stuno ON student ;
CREATE INDEX idx_age_name ON student (age , NAME);

EXPLAIN SELECT * FROM student WHERE age &lt;&gt;20;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080035462.png" alt="image-20220327194911745"></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT id, age , NAME FROM student WHERE age &lt;&gt; 28;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080035507.png" alt="image-20220327195102695"></p>
<p>上述都使用到了声明的索引，下面的情况则不然，在查询列中多了一列classid，显示未使用到索引:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT id, age , NAME,classid FROM student WHERE age &lt;&gt; 28;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080035445.png" alt="image-20220327195221475"></p>
<p>举例二：</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">EXPLAIN SELECT *FROM student WHERE NAME LIKE &#39;%abc&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080034296.png" alt="image-20220327195413811"></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE INDEX idx_age_name ON student (age , NAME);
EXPLAIN SELECT id, age ,NAME FROM student WHERE NAME LIKE &#39;%abc &#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080035534.png" alt="image-20220327195610323"></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql"># 索引覆盖失效
EXPLAIN SELECT id, age ,NAME,classid FROM student WHERE NAME LIKE &#39;%abc &#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>查询多了classid，结果是未使用到索引</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080034785.png" alt="image-20220327195812263"></p>
<blockquote>
<p>之前有说过，不等于与左模糊会导致索引失效。但是这里为什么又用上了呢？原因是优化器发现，数据已经都在索引了。直接遍历索引就可以返回数据。。而遍历索引，肯定是比遍历全表数据量少的。这样IO就可以更少。</p>
<p>一切都是成本的考量。</p>
</blockquote>
<h3 id="7-2-覆盖索引的利弊"><a href="#7-2-覆盖索引的利弊" class="headerlink" title="7.2 覆盖索引的利弊"></a>7.2 覆盖索引的利弊</h3><p><strong>好处：</strong></p>
<p><strong>1.</strong> <strong>避免Innodb表进行索引的二次查询（回表）</strong></p>
<p>Innodb是以聚集索引的顺序来存储的，对于Innodb来说，二级索引在叶子节点中所保存的是行的主键信息，如果是用二级索引查询数据，在查找到相应的键值后，还需通过主键进行二次查询才能获取我们真实所需要的数据。</p>
<p>在覆盖索引中，二级索引的键值中可以获取所要的数据，<code>避免了对主键的二次查询，减少了IO操作</code>，提升了查询效率。</p>
<p><strong>2.</strong> <strong>可以把随机IO变成顺序IO加快查询效率</strong></p>
<p>由于覆盖索引是按键值的顺序存储的，对于I0密集型的范围查找来说，对比随机从磁盘读取每一行的数据IO要少的多，因此利用覆盖索引在访问时也可以把磁盘的<code>随机读取的IO</code>转变成索引查找的<code>顺序IO</code>。</p>
<p><strong>3.数据在索引里面数据量少更紧凑</strong></p>
<p>索引肯定是比原来的数据，数据量少。。这样就可以减少IO.</p>
<p><strong>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段。</strong></p>
<p><strong>弊端：</strong></p>
<p><code>索引字段的维护</code>总是有代价的。因此，在建立冗余索引来支持覆盖索引时就需要权衡考虑了。这是业务DBA，或者称为业务数据架构师的工作。</p>
<h2 id="8、如何给字符串添加索引"><a href="#8、如何给字符串添加索引" class="headerlink" title="8、如何给字符串添加索引"></a>8、如何给字符串添加索引</h2><p>有一张教师表，表定义如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> teacher<span class="token punctuation">(</span>
ID <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
email <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>讲师要使用邮箱登录，所以业务代码中一定会出现类似于这样的语句：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> col1<span class="token punctuation">,</span> col2 <span class="token keyword">from</span> teacher <span class="token keyword">where</span> email<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果email这个字段上没有索引，那么这个语句就只能做 全表扫描 。</p>
<h3 id="8-1-前缀索引"><a href="#8-1-前缀索引" class="headerlink" title="8.1 前缀索引"></a>8.1 前缀索引</h3><p>MySQL是支持前缀索引的。默认地，如果你创建索引的语句不指定前缀长度，那么索引就会包含整个字 符串。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> teacher <span class="token keyword">add</span> <span class="token keyword">index</span> index1<span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 或</span>
mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> teacher <span class="token keyword">add</span> <span class="token keyword">index</span> index2<span class="token punctuation">(</span>email<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这两种不同的定义在数据结构和存储上有什么区别呢？下图就是这两个索引的示意图。</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080034877.png" alt="image-20220628222806140"></p>
<p>以及</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080034735.png" alt="image-20220628222813404"></p>
<p>&#x3D;&#x3D;如果使用的是index1&#x3D;&#x3D;（即email整个字符串的索引结构），执行顺序是这样的： </p>
<ol>
<li>从index1索引树找到满足索引值是’ <a href="mailto:&#x7a;&#x68;&#x61;&#x6e;&#103;&#115;&#115;&#x78;&#121;&#x7a;&#64;&#120;&#x78;&#x78;&#46;&#x63;&#111;&#109;">&#x7a;&#x68;&#x61;&#x6e;&#103;&#115;&#115;&#x78;&#121;&#x7a;&#64;&#120;&#x78;&#x78;&#46;&#x63;&#111;&#109;</a> ’的这条记录，取得ID2的值； </li>
<li>到主键上查到主键值是ID2的行，判断email的值是正确的，将这行记录加入结果集； </li>
<li>取index1索引树上刚刚查到的位置的下一条记录，发现已经不满足email&#x3D;’ <a href="mailto:&#x7a;&#x68;&#x61;&#110;&#103;&#x73;&#x73;&#x78;&#121;&#122;&#64;&#120;&#x78;&#x78;&#46;&#99;&#x6f;&#109;">&#x7a;&#x68;&#x61;&#110;&#103;&#x73;&#x73;&#x78;&#121;&#122;&#64;&#120;&#x78;&#x78;&#46;&#99;&#x6f;&#109;</a> ’的 条件了，循环结束</li>
</ol>
<p>这个过程中，只需要回主键索引取一次数据，所以系统认为只扫描了一行。</p>
<p>&#x3D;&#x3D;如果使用的是index2&#x3D;&#x3D;（即email(6)索引结构），执行顺序是这样的： </p>
<ol>
<li>从index2索引树找到满足索引值是’zhangs’的记录，找到的第一个是ID1； </li>
<li>到主键上查到主键值是ID1的行，判断出email的值不是’ <a href="mailto:&#122;&#x68;&#97;&#x6e;&#103;&#115;&#x73;&#x78;&#x79;&#122;&#x40;&#120;&#120;&#x78;&#x2e;&#99;&#x6f;&#x6d;">&#122;&#x68;&#97;&#x6e;&#103;&#115;&#x73;&#x78;&#x79;&#122;&#x40;&#120;&#120;&#x78;&#x2e;&#99;&#x6f;&#x6d;</a> ’，这行记录丢弃； </li>
<li>取index2上刚刚查到的位置的下一条记录，发现仍然是’zhangs’，取出ID2，再到ID索引上取整行然 后判断，这次值对了，将这行记录加入结果集； </li>
<li>重复上一步，直到在idxe2上取到的值不是’zhangs’时，循环结束。</li>
</ol>
<p>也就是说<strong>使用前缀索引，定义好长度，就可以做到既节省空间，又不用额外增加太多的查询成本</strong>。前面 已经讲过区分度，区分度越高越好。因为区分度越高，意味着重复的键值越少。</p>
<h3 id="8-2-前缀索引对覆盖索引的影响"><a href="#8-2-前缀索引对覆盖索引的影响" class="headerlink" title="8.2 前缀索引对覆盖索引的影响"></a>8.2 前缀索引对覆盖索引的影响</h3><p>​	使用前缀索引就用不上覆盖索引对查询性能的优化了，这也是你在选择是否使用前缀索引时需要考 虑的一个因素。</p>
<h2 id="9、索引条件下推"><a href="#9、索引条件下推" class="headerlink" title="9、索引条件下推"></a>9、索引条件下推</h2><h3 id="9-1-使用前后对比"><a href="#9-1-使用前后对比" class="headerlink" title="9.1 使用前后对比"></a>9.1 使用前后对比</h3><p>​	Index Condition Pushdown(ICP)是MySQL 5.6中新特性，是一种在存储引擎层使用索引过滤数据的一种优化方式。</p>
<ul>
<li>如果没有ICP，存储引擎会遍历索引以定位基表中的行，并将它们返回给MySQL服务器，由MySQL服务器评估<code>WHERE</code>后面的条件是否保留行。</li>
<li>启用ICP后，如果部分<code>WHERE</code>条件可以仅使用索引中的列进行筛选，则MySQL服务器会把这部分<code>WHERE</code>条件放到存储引擎筛选。然后，存储引擎通过使用索引条目来筛选数据，并且只有在满足这一条件时才从表中读取行。<ul>
<li>好处:  ICP可以减少存储引擎必须访问基表的次数和MySQL服务器必须访问存储引擎的次数。</li>
<li>但是，ICP的<code>加速效果</code>取决于在存储引擎内通过<code>ICP筛选</code>掉的数据的比例。</li>
</ul>
</li>
</ul>
<p>例子：</p>
<p>key1 有索引</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080034373.png" alt="image-20220327201222126"></p>
<blockquote>
<p>这里条件like ‘%a’ 其实可以在索引里面，算出来哪些符合条件。。。。过滤出符合条件的，再回表。这样回表的数据可以减少很多。还有一个好处，没有索引下推，就需要把数据都回表查出来，，这些数据可能在不同的页当中，又会产生IO</p>
<p>条件下推，下推到下一个条件符不符合。</p>
</blockquote>
<h3 id="9-2-ICP的开启-关闭"><a href="#9-2-ICP的开启-关闭" class="headerlink" title="9.2 ICP的开启&#x2F;关闭"></a>9.2 ICP的开启&#x2F;关闭</h3><ul>
<li><p>默认情况下启用索引条件下推。可以通过设置系统变量<code>optimizer_switch</code>控制:<code>index_condition_pushdown</code></p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">#打开索引下推
SET optimizer_switch &#x3D; &#39;index_condition_pushdown&#x3D;off &#39; ;
#关闭索引下推
SET optimizer_switch &#x3D; &#39;index_condition_pushdown&#x3D;on &#39; ;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>当使用索引条件下推时，<code>EXPLAIN</code>语句输出结果中Extra列内容显示为<code>Using index condition</code> 。</p>
</li>
</ul>
<h3 id="9-3ICP使用案例"><a href="#9-3ICP使用案例" class="headerlink" title="9.3ICP使用案例"></a>9.3ICP使用案例</h3><p>建表</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">CREATE TABLE &#96;people&#96; (
	&#96;id&#96; INT NOT NULL AUTO_INCREMENT,
	&#96;zipcode&#96; VARCHAR ( 20 ) COLLATE utf8_bin DEFAULT NULL,
	&#96;firstname&#96; varchar(20)COLLATE utf8_bin DEFAULT NULL,
	&#96;lastname&#96; varchar(20) COLLATE utf8_bin DEFAULT NULL,
	&#96;address&#96; varchar (50)COLLATE utf8_bin DEFAULT NULL,
	PRIMARY KEY ( &#96;id&#96;),
KEY &#96;zip_last_first&#96;( &#96;zipcode&#96; , &#96;lastname&#96;, &#96;firstname&#96;)
)ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;5 DEFAULT CHARSET&#x3D;utf8mb3 COLLATE&#x3D;utf8_bin;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>插入数据</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">INSERT INTO &#96;people&#96; VALUES
( &#39;1&#39;, &#39;000001&#39;,&#39;三&#39;,&#39;张&#39;,&#39;北京市&#39;),
 ( &#39;2&#39;, &#39;000002 &#39;,&#39;四&#39;,&#39;李&#39;,&#39;南京市&#39;),
 ( &#39;3&#39;, &#39;000003&#39;, &#39;五&#39;,&#39;王&#39;,&#39;上海市&#39;),
 ( &#39;4 &#39;, &#39;000001&#39;,&#39;六&#39;,&#39;赵&#39;,&#39;天津市&#39;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<p>为该表定义联合索引zip_last_first (zipcode，lastname，firstname)。如果我们知道了一个人的邮编，但是不确定这个人的姓氏，我们可以进行如下检索:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT *FROM people
WHERE zipcode&#x3D; &#39;000001&#39;
AND lastname LIKE &#39;%张%&#39;
AND address LIKE &#39;%北京市%&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080033902.png" alt="image-20220327212419933"></p>
<p>执行查看SQL的查询计划，Extra中显示了<code>Using index condition</code>，这表示使用了索引下推。另外，<code>Usingwhere</code>表示条件中包含需要过滤的非索引列的数据，即address LIKE ‘%北京市%’这个条件并不是索引列，需要在服务端过滤掉。</p>
<h3 id="9-4开启和关闭ICP的性能对比"><a href="#9-4开启和关闭ICP的性能对比" class="headerlink" title="9.4开启和关闭ICP的性能对比"></a>9.4开启和关闭ICP的性能对比</h3><p>创建存储过程，主要目的就是插入很多000001的数据，这样查询的时候为了在存储引擎层做过滤，减少IO，也为了减少缓冲池（缓存数据页，没有IO）的作用。</p>
<pre class="line-numbers language-MYSQL" data-language="MYSQL"><code class="language-MYSQL">DELIMITER &#x2F;&#x2F;
CREATE PROCEDURE insert_people( max_num INT )
BEGIN
DECLARE i INT DEFAULT 0;
	SET autocommit &#x3D; 0;
	REPEAT
	SET i &#x3D; i + 1;
	INSERT INTo people ( zipcode, firstname , lastname , address ) VALUES ( &#39;000001&#39;,&#39;六&#39;, &#39;赵&#39;,&#39;天津市&#39;);

	UNTIL i &#x3D; max_num
	END REPEAT;
	COMMIT;
END &#x2F;&#x2F;
DELIMITER ;

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调用存储过程</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">call insert_people(1000000);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>首先打开<code>profiling</code>。</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">#查看
mysql&gt; show variables like &#39;profiling%&#39;;
+------------------------+-------+
| Variable_name          | Value |
+------------------------+-------+
| profiling              | OFF   |
| profiling_history_size | 15    |
+------------------------+-------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">set profiling&#x3D;1 ;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>执行SQL语句，此时默认打开索引下推。</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT * FROM people WHERE zipcode&#x3D; &#39;000001&#39; AND lastname LIKE &#39;%张%&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<p>再次执行sQL语句，不使用索引下推</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT &#x2F;*+ no_icp (people) *&#x2F; * FROM people WHERE zipcode&#x3D;&#39;000001&#39; AND lastname LIKE &#39;%张%&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>查看当前会话所产生的所有profiles</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">show profiles\G ;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>结果如下。</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080032389.png" alt="image-20220327214304560"></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080032131.png" alt="image-20220327214423178"></p>
<p>多次测试效率对比来看，使用ICP优化的查询效率会好一些。这里建议多存储一些数据效果更明显。</p>
<h3 id="9-5-使用前后的扫描过程"><a href="#9-5-使用前后的扫描过程" class="headerlink" title="9.5 使用前后的扫描过程"></a>9.5 使用前后的扫描过程</h3><h4 id="在不使用ICP索引扫描的过程："><a href="#在不使用ICP索引扫描的过程：" class="headerlink" title="在不使用ICP索引扫描的过程："></a><strong>在不使用ICP索引扫描的过程：</strong></h4><p>storage层：只将满足index key条件的索引记录对应的整行记录取出，返回给server层 </p>
<p>server 层：对返回的数据，使用后面的where条件过滤，直至返回最后一行。</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080032021.png" alt="image-20220628222936957"></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080032205.png" alt="image-20220628222949568"></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080032941.png" alt="image-20220327181901279"></p>
<h4 id="使用ICP扫描的过程："><a href="#使用ICP扫描的过程：" class="headerlink" title="使用ICP扫描的过程："></a><strong>使用ICP扫描的过程：</strong></h4><ul>
<li><p><strong>storage层</strong>：首先将index key条件满足的索引记录区间确定，然后在索引上使用index filter进行过滤。将满足的index filter条件的索引记录才去回表取出整行记录返回server层。不满足index filter条件的索引记录丢弃，不回表、也不会返回server层。</p>
</li>
<li><p><strong>server 层</strong>：对返回的数据，使用table filter条件做最后的过滤。</p>
</li>
</ul>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080032901.png" alt="image-20220628223057536"></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080032390.png" alt="image-20220628223108912"></p>
<h4 id="使用前后的成本差别"><a href="#使用前后的成本差别" class="headerlink" title="使用前后的成本差别"></a>使用前后的成本差别</h4><ul>
<li>使用前，存储层多返回了需要被index filter过滤掉的整行记录 </li>
<li>使用ICP后，直接就去掉了不满足index filter条件的记录，省去了他们回表和传递到server层的成本。 </li>
<li>ICP的 加速效果 取决于在存储引擎内通过 ICP筛选 掉的数据的比例。</li>
</ul>
<h3 id="9-6-ICP的使用条件"><a href="#9-6-ICP的使用条件" class="headerlink" title="9.6 ICP的使用条件"></a>9.6 ICP的使用条件</h3><p>① 只能用于二级索引(secondary index) </p>
<p>②explain显示的执行计划中type值（join 类型）为 <strong>range 、 ref 、 eq_ref 或者 ref_or_null</strong> 。</p>
<p>③ 并非全部where条件都可以用ICP筛选，如果where条件的字段不在索引列中，还是要读取整表的记录 到server端做where过滤。 </p>
<p>④ ICP可以用于MyISAM和InnnoDB存储引擎 </p>
<p>⑤ MySQL 5.6版本的不支持分区表的ICP功能，5.7版本的开始支持。 </p>
<p>⑥ 当SQL使用覆盖索引时，不支持ICP优化方法。</p>
<blockquote>
<ol>
<li><p>如果表访问的类型为range、ref、eq_ref和ref_or_null可以使用ICP</p>
</li>
<li><p>ICP可以用于<code>InnoDB</code>和<code>MyISAM</code>表，包括分区表<code>InnoDB</code>和<code>MyISAM</code>表</p>
</li>
<li><p>对于<code>InnoDB</code>表，<code>ICP</code>仅用于二级索引。ICP的目标是减少全行读取次数，从而减少I&#x2F;o操作。</p>
</li>
<li><p>当SQL使用覆盖索引时，不支持ICP。因为这种情况下使用ICP不会减少I&#x2F;O。</p>
<p>索引覆盖不能使用，一个原因是，索引覆盖，不需要回表。。ICP作用是减小回表，ICP需要回表</p>
</li>
<li><p>相关子查询的条件不能使用ICP</p>
</li>
</ol>
</blockquote>
<h3 id="9-7-ICP使用案例"><a href="#9-7-ICP使用案例" class="headerlink" title="9.7 ICP使用案例"></a>9.7 ICP使用案例</h3><p>案例1</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tuser
<span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'张%'</span>
<span class="token operator">AND</span> age <span class="token operator">=</span> <span class="token number">10</span>
<span class="token operator">AND</span> ismale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080032365.png" alt="image-20220628223402719"></p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080032230.png" alt="image-20220628223409573"></p>
<p>案例2</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080032926.png" alt="image-20220628223425784"></p>
<h2 id="10、普通索引-vs-唯一索引"><a href="#10、普通索引-vs-唯一索引" class="headerlink" title="10、普通索引 vs 唯一索引"></a>10、普通索引 vs 唯一索引</h2><p>&#x3D;&#x3D;从性能的角度考虑，你选择唯一索引还是普通索引呢？选择的依据是什么呢？&#x3D;&#x3D; </p>
<p>假设，我们有一个主键列为ID的表，表中有字段k，并且在k上有索引，假设字段 k 上的值都不重复。 这个表的建表语句是：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> test<span class="token punctuation">(</span>
  id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
  k <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
  name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">index</span> <span class="token punctuation">(</span>k<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>表中R1~R5的(ID,k)值分别为(100,1)、(200,2)、(300,3)、(500,5)和(600,6)。</p>
<h3 id="10-1-查询过程"><a href="#10-1-查询过程" class="headerlink" title="10.1 查询过程"></a>10.1 查询过程</h3><p>假设，执行查询的语句是 select id from test where k&#x3D;5。</p>
<ul>
<li>对于普通索引来说，查找到满足条件的第一个记录(5,500)后，需要查找下一个记录，直到碰到第一 个不满足k&#x3D;5条件的记录。 </li>
<li>对于唯一索引来说，由于索引定义了唯一性，查找到第一个满足条件的记录后，就会停止继续检索。</li>
</ul>
<p>那么，这个不同带来的性能差距会有多少呢？答案是， <strong>微乎其微</strong> 。</p>
<h3 id="10-2-更新过程"><a href="#10-2-更新过程" class="headerlink" title="10.2 更新过程"></a>10.2 更新过程</h3><p>​	为了说明普通索引和唯一索引对更新语句性能的影响这个问题，介绍一下change buffer。 </p>
<p>​	当需要更新一个数据页时，如果数据页在内存中就直接更新，而如果这个数据页还没有在内存中的话， 在不影响数据一致性的前提下， <strong>InooDB会将这些更新操作缓存在change buffer中</strong> ，这样就不需要从磁 盘中读入这个数据页了。在下次查询需要访问这个数据页的时候，将数据页读入内存，然后执行change buffer中与这个页有关的操作。通过这种方式就能保证这个数据逻辑的正确性。 </p>
<p>​	将change buffer中的操作应用到原数据页，得到最新结果的过程称为 <strong>merge</strong> 。除了 <strong>访问这个数据页</strong> 会触 发merge外，系统有 <strong>后台线程会定期 merge</strong>。在 <strong>数据库正常关闭（shutdown）</strong> 的过程中，也会执行merge 操作。 </p>
<p>​	如果能够将更新操作先记录在change buffer， <strong>减少读磁盘</strong> ，语句的执行速度会得到明显的提升。而且， 数据读入内存是需要占用 buffer pool 的，所以这种方式还能够 <strong>避免占用内存</strong> ，提高内存利用率。 </p>
<p>​	<strong>唯一索引的更新就不能使用change buffer</strong> ，实际上也只有普通索引可以使用。 </p>
<p>&#x3D;&#x3D;如果要在这张表中插入一个新记录(4,400)的话，InnoDB的处理流程是怎样的？&#x3D;&#x3D;</p>
<h3 id="10-3-change-buffer的使用场景"><a href="#10-3-change-buffer的使用场景" class="headerlink" title="10.3 change buffer的使用场景"></a>10.3 change buffer的使用场景</h3><ol>
<li>普通索引和唯一索引应该怎么选择？其实，这两类索引在查询能力上是没差别的，主要考虑的是 对 <strong>更新性能</strong> 的影响。所以，建议你 <strong>尽量选择普通索引</strong> 。 </li>
<li>在实际使用中会发现， <strong>普通索引 和 change buffer</strong> 的配合使用，对于 <strong>数据量大</strong> 的表的更新优化 还是很明显的。 </li>
<li>如果所有的更新后面，都马上 <strong>伴随着对这个记录的查询</strong> ，那么你应该 <strong>关闭change buffer</strong> 。而在 其他情况下，change buffer都能提升更新性能。 </li>
<li>由于唯一索引用不上change buffer的优化机制，因此如果 <strong>业务可以接受</strong> ，从性能角度出发建议优 先考虑非唯一索引。但是如果”业务可能无法确保”的情况下，怎么处理呢？ <ul>
<li>首先， <strong>业务正确性优先</strong> 。我们的前提是“业务代码已经保证不会写入重复数据”的情况下，讨论性能 问题。如果业务不能保证，或者业务就是要求数据库来做约束，那么没得选，必须创建唯一索引。 这种情况下，本节的意义在于，如果碰上了大量插入数据慢、内存命中率低的时候，给你多提供一 个排查思路。 </li>
<li>然后，在一些“ <strong>归档库</strong> ”的场景，你是可以考虑使用唯一索引的。比如，线上数据只需要保留半年， 然后历史数据保存在归档库。这时候，归档数据已经是确保没有唯一键冲突了。要提高归档效率， 可以考虑把表里面的唯一索引改成普通索引。</li>
</ul>
</li>
</ol>
<h2 id="11、其它查询优化策略"><a href="#11、其它查询优化策略" class="headerlink" title="11、其它查询优化策略"></a>11、其它查询优化策略</h2><h3 id="11-1-EXISTS-和-IN-的区分"><a href="#11-1-EXISTS-和-IN-的区分" class="headerlink" title="11.1 EXISTS 和 IN 的区分"></a>11.1 EXISTS 和 IN 的区分</h3><p><strong>问题：</strong></p>
<p>不太理解哪种情况下应该使用 EXISTS，哪种情况应该用 IN。选择的标准是看能否使用表的索引吗？</p>
<p><strong>回答：</strong></p>
<p>索引是个前提，其实选择与否还是要看表的大小。你可以将选择的标准理解为<code>小表驱动大表</code>。在这种方式下效率是最高的。</p>
<p>比如下面这样:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT *FROM A WHERE cc IN (SELECT cc FROM B)

SELECT *FROM A WHERE EXISTS (SELECT cc FROM B WHERE B.cc&#x3D;A.cc)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<p>当A小于B时，用EXISTS。因为EXISTS的实现，相当于外表循环，实现的逻辑类似于:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">for i in A
	for j in B
		if j.cc &#x3D;&#x3D; i.cc then ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


<p>当B小于A时用IN，因为实现的逻辑类似于:</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">for i in B
	for j in A
		if j.cc &#x3D;&#x3D; i.cc then ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>哪个表小就用哪个表来驱动，A表小就用EXISTS，B表小就用IN。</p>
<h3 id="11-2-COUNT-与COUNT-具体字段-效率"><a href="#11-2-COUNT-与COUNT-具体字段-效率" class="headerlink" title="11.2 COUNT(*)与COUNT(具体字段)效率"></a>11.2 COUNT(*)与COUNT(具体字段)效率</h3><p>问：在 MySQL 中统计数据表的行数，可以使用三种方式： SELECT COUNT(*) 、 SELECT COUNT(1) 和 SELECT COUNT(具体字段) ，使用这三者之间的查询效率是怎样的？</p>
<p><strong>环节1：</strong><code>COUNT(*)</code>和<code>COUNT(1)</code>都是对所有结果进行<code>COUNT</code>，<code>COUNT(*)</code>和<code>COUNT(1)</code>本质上并没有区别（二者执行时间可能略有差别，不过你还是可以把它俩的执行效率看成是相等的）。如果有WHERE子句，则是对所有符合筛选条件的数据行进行统计；如果没有WHERE子句，则是对数据表的数据行数进行统计。</p>
<p><strong>环节2：</strong>如果是MyISAM存储引擎，统计数据表的行数只需要<code>O(1)</code>的复杂度，这是因为每张MyISAM的数据表都有一个meta信息存储了<code>row_count</code>值，而一致性则是由表级锁来保证的。</p>
<p>如果是InnoDB存储引擎，因为InnoDB支持事务，采用行级锁和MVCC机制，所以无法像MyISAM一样，维护一个row_count变量，因此需要采用<code>扫描全表</code>，是<code>O(n)</code>的复杂度，进行循环+计数的方式来完成统计。</p>
<p><strong>环节3（重点）：</strong>在InnoDB引擎中，如果采用<code>COUNT(具体字段)</code>来统计数据行数，要尽量采用二级索引。因为主键采用的索引是聚簇索引，聚簇索引包含的信息多，明显会大于二级索引（非聚簇索引）。对于<code>COUNT(*)</code>和<code>COUNT(1)</code>来说，它们不需要查找具体的行，只是统计行数，系统会<code>自动</code>采用占用空间更小的二级索引来进行统计。</p>
<p>如果有多个二级索引，会使用key_len小的二级索引进行扫描。当没有二级索引的时候，才会采用主键索引来进行统计。</p>
<h3 id="11-3-关于SELECT"><a href="#11-3-关于SELECT" class="headerlink" title="11.3 关于SELECT(*)"></a>11.3 关于SELECT(*)</h3><p>在表查询中，建议明确字段，不要使用 * 作为查询的字段列表，推荐使用SELECT &lt;字段列表&gt; 查询。原因：</p>
<p>① MySQL 在解析的过程中，会通过<code>查询数据字典</code>将”*”按序转换成所有列名，这会大大的耗费资源和时间。</p>
<p>② 无法使用<code>覆盖索引</code></p>
<h3 id="11-4-LIMIT-1-对优化的影响"><a href="#11-4-LIMIT-1-对优化的影响" class="headerlink" title="11.4 LIMIT 1 对优化的影响"></a>11.4 LIMIT 1 对优化的影响</h3><p>针对的是会扫描全表的 SQL 语句，如果你可以确定结果集只有一条，那么加上<code>LIMIT 1</code>的时候，当找到一条结果的时候就不会继续扫描了，这样会加快查询速度。</p>
<p>如果数据表已经对字段建立了唯一索引，那么可以通过索引进行查询，不会全表扫描的话，就不需要加上<code>LIMIT 1</code>了。</p>
<h3 id="11-5-多使用COMMIT"><a href="#11-5-多使用COMMIT" class="headerlink" title="11.5 多使用COMMIT"></a>11.5 多使用COMMIT</h3><p>只要有可能，在程序中尽量多使用 COMMIT，这样程序的性能得到提高，需求也会因为 COMMIT 所释放的资源而减少。</p>
<p>COMMIT 所释放的资源：</p>
<ul>
<li><p>回滚段上用于恢复数据的信息</p>
</li>
<li><p>被程序语句获得的锁</p>
</li>
<li><p>redo &#x2F; undo log buffer 中的空间</p>
</li>
<li><p>管理上述 3 种资源中的内部花费</p>
</li>
</ul>
<h2 id="12、淘宝数据库，主键如何设计的？"><a href="#12、淘宝数据库，主键如何设计的？" class="headerlink" title="12、淘宝数据库，主键如何设计的？"></a>12、淘宝数据库，主键如何设计的？</h2><p>聊一个实际问题：淘宝的数据库，主键是如何设计的？ </p>
<p>某些错的离谱的答案还在网上年复一年的流传着，甚至还成为了所谓的MySQL军规。其中，一个最明显的错误就是关于MySQL的主键设计。 </p>
<p>大部分人的回答如此自信：用8字节的 BIGINT 做主键，而不要用INT。 错 ！</p>
<p>这样的回答，只站在了数据库这一层，而没有 <strong>从业务的角度</strong> 思考主键。主键就是一个自增ID吗？站在 2022年的新年档口，用自增做主键，架构设计上可能 <strong>连及格都拿不到</strong> 。</p>
<h3 id="12-1-自增ID的问题"><a href="#12-1-自增ID的问题" class="headerlink" title="12.1 自增ID的问题"></a>12.1 自增ID的问题</h3><p>​	自增ID做主键，简单易懂，几乎所有数据库都支持自增类型，只是实现上各自有所不同而已。自增ID除 了简单，其他都是缺点，总体来看存在以下几方面的问题： </p>
<ol>
<li>可靠性不高 存在自增ID回溯的问题，这个问题直到最新版本的MySQL 8.0才修复。 </li>
<li>安全性不高 对外暴露的接口可以非常容易猜测对应的信息。比如：&#x2F;User&#x2F;1&#x2F;这样的接口，可以非常容易猜测用户ID的 值为多少，总用户数量有多少，也可以非常容易地通过接口进行数据的爬取。 </li>
<li>性能差 自增ID的性能较差，需要在数据库服务器端生成。 </li>
<li>交互多 业务还需要额外执行一次类似 last_insert_id() 的函数才能知道刚才插入的自增值，这需要多一次的 网络交互。在海量并发的系统中，多1条SQL，就多一次性能上的开销。</li>
<li>局部唯一性 最重要的一点，自增ID是局部唯一，只在当前数据库实例中唯一，而不是全局唯一，在任意服务器间都 是唯一的。对于目前分布式系统来说，这简直就是噩梦。</li>
</ol>
<h3 id="12-2-业务字段做主键"><a href="#12-2-业务字段做主键" class="headerlink" title="12.2 业务字段做主键"></a>12.2 业务字段做主键</h3><p>​	为了能够唯一地标识一个会员的信息，需要为 会员信息表 设置一个主键。那么，怎么为这个表设置主 键，才能达到我们理想的目标呢？ 这里我们考虑业务字段做主键。 </p>
<p>表数据如下：</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080031291.png" alt="image-20220628225020998"></p>
<p>在这个表里，哪个字段比较合适呢？</p>
<ul>
<li>选择卡号（cardno）</li>
</ul>
<p>会员卡号（cardno）看起来比较合适，因为会员卡号不能为空，而且有唯一性，可以用来 标识一条会员记录</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> demo<span class="token punctuation">.</span>membermaster
    <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span>
    <span class="token operator">-</span><span class="token operator">></span> cardno <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span> <span class="token comment">-- 会员卡号为主键</span>
    <span class="token operator">-</span><span class="token operator">></span> membername <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">></span> memberphone <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">></span> memberpid <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">></span> memberaddress <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">></span> sex <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">></span> birthday <span class="token keyword">DATETIME</span>
    <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.06</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​	不同的会员卡号对应不同的会员，字段“cardno”唯一地标识某一个会员。如果都是这样，会员卡号与会 员一一对应，系统是可以正常运行的。 </p>
<p>​	但实际情况是， <strong>会员卡号可能存在重复使用</strong> 的情况。比如，张三因为工作变动搬离了原来的地址，不再 到商家的门店消费了 （退还了会员卡），于是张三就不再是这个商家门店的会员了。但是，商家不想让 这个会 员卡空着，就把卡号是“10000001”的会员卡发给了王五。 </p>
<p>​	从系统设计的角度看，这个变化只是修改了会员信息表中的卡号是“10000001”这个会员 信息，并不会影 响到数据一致性。也就是说，修改会员卡号是“10000001”的会员信息， 系统的各个模块，都会获取到修 改后的会员信息，不会出现“有的模块获取到修改之前的会员信息，有的模块获取到修改后的会员信息， 而导致系统内部数据不一致”的情况。因此，从 <strong>信息系统层面</strong> 上看是没问题的。 </p>
<p>​	但是从使用 <strong>系统的业务层面</strong> 来看，就有很大的问题 了，会对商家造成影响。 </p>
<p>​	比如，我们有一个销售流水表（trans），记录了所有的销售流水明细。2020 年 12 月 01 日，张三在门店 购买了一本书，消费了 89 元。那么，系统中就有了张三买书的流水记录，如下所示：</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080031051.png" alt="image-20220628225035008"></p>
<p>接着，我们查询一下 2020 年 12 月 01 日的会员销售记录：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> b<span class="token punctuation">.</span>membername<span class="token punctuation">,</span>c<span class="token punctuation">.</span>goodsname<span class="token punctuation">,</span>a<span class="token punctuation">.</span>quantity<span class="token punctuation">,</span>a<span class="token punctuation">.</span>salesvalue<span class="token punctuation">,</span>a<span class="token punctuation">.</span>transdate
    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">FROM</span> demo<span class="token punctuation">.</span>trans <span class="token keyword">AS</span> a
    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">JOIN</span> demo<span class="token punctuation">.</span>membermaster <span class="token keyword">AS</span> b
    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">JOIN</span> demo<span class="token punctuation">.</span>goodsmaster <span class="token keyword">AS</span> c
    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">ON</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>cardno <span class="token operator">=</span> b<span class="token punctuation">.</span>cardno <span class="token operator">AND</span> a<span class="token punctuation">.</span>itemnumber<span class="token operator">=</span>c<span class="token punctuation">.</span>itemnumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+----------+------------+---------------------+</span>
<span class="token operator">|</span> membername <span class="token operator">|</span> goodsname <span class="token operator">|</span> quantity <span class="token operator">|</span> salesvalue <span class="token operator">|</span> transdate <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+----------+------------+---------------------+</span>
<span class="token operator">|</span> 张三 <span class="token operator">|</span> 书 <span class="token operator">|</span> <span class="token number">1.000</span> <span class="token operator">|</span> <span class="token number">89.00</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+----------+------------+---------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果会员卡“10000001”又发给了王五，我们会更改会员信息表。导致查询时：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> b<span class="token punctuation">.</span>membername<span class="token punctuation">,</span>c<span class="token punctuation">.</span>goodsname<span class="token punctuation">,</span>a<span class="token punctuation">.</span>quantity<span class="token punctuation">,</span>a<span class="token punctuation">.</span>salesvalue<span class="token punctuation">,</span>a<span class="token punctuation">.</span>transdate
    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">FROM</span> demo<span class="token punctuation">.</span>trans <span class="token keyword">AS</span> a
    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">JOIN</span> demo<span class="token punctuation">.</span>membermaster <span class="token keyword">AS</span> b
    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">JOIN</span> demo<span class="token punctuation">.</span>goodsmaster <span class="token keyword">AS</span> c
    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">ON</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>cardno <span class="token operator">=</span> b<span class="token punctuation">.</span>cardno <span class="token operator">AND</span> a<span class="token punctuation">.</span>itemnumber<span class="token operator">=</span>c<span class="token punctuation">.</span>itemnumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+----------+------------+---------------------+</span>
<span class="token operator">|</span> membername <span class="token operator">|</span> goodsname <span class="token operator">|</span> quantity <span class="token operator">|</span> salesvalue <span class="token operator">|</span> transdate <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+----------+------------+---------------------+</span>
<span class="token operator">|</span> 王五 <span class="token operator">|</span> 书 <span class="token operator">|</span> <span class="token number">1.000</span> <span class="token operator">|</span> <span class="token number">89.00</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------+-----------+----------+------------+---------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>选择会员电话 或 身份证号</li>
</ul>
<p>​	会员电话可以做主键吗？不行的。在实际操作中，手机号也存在 <strong>被运营商收回</strong> ，重新发给别人用的情 况。 </p>
<p>​	那身份证号行不行呢？好像可以。因为身份证决不会重复，身份证号与一个人存在一一对 应的关系。可 问题是，身份证号属于 <strong>个人隐私</strong> ，顾客不一定愿意给你。要是强制要求会员必须登记身份证号，会把很 多客人赶跑的。其实，客户电话也有这个问题，这也是我们在设计会员信息表的时候，允许身份证号和 电话都为空的原因。 </p>
<p>​	<strong>所以，建议尽量不要用跟业务有关的字段做主键。毕竟，作为项目设计的技术人员，我们谁也无法预测 在项目的整个生命周期中，哪个业务字段会因为项目的业务需求而有重复，或者重用之类的情况出现</strong></p>
<blockquote>
<p>经验： </p>
<p>​	刚开始使用 MySQL 时，很多人都很容易犯的错误是喜欢用业务字段做主键，想当然地认为了解业 务需求，但实际情况往往出乎意料，而更改主键设置的成本非常高。</p>
</blockquote>
<h3 id="12-3-淘宝的主键设计"><a href="#12-3-淘宝的主键设计" class="headerlink" title="12.3 淘宝的主键设计"></a>12.3 淘宝的主键设计</h3><p>​	在淘宝的电商业务中，订单服务是一个核心业务。请问， 订单表的主键 淘宝是如何设计的呢？是自增ID 吗？ 打开淘宝，看一下订单信息：</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080031844.png" alt="image-20220628225047528"></p>
<p>从上图可以发现，订单号不是自增ID！我们详细看下上述4个订单号：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1550672064762308113</span>
<span class="token number">1481195847180308113</span>
<span class="token number">1431156171142308113</span>
<span class="token number">1431146631521308113</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>订单号是19位的长度，且订单的最后5位都是一样的，都是08113。且订单号的前面14位部分是单调递增的。 大胆猜测，淘宝的订单ID设计应该是：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">订单ID <span class="token operator">=</span> 时间 <span class="token operator">+</span> 去重字段 <span class="token operator">+</span> 用户ID后<span class="token number">6</span>位尾号<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样的设计能做到全局唯一，且对分布式系统查询及其友好。</p>
<h3 id="12-4-推荐的主键设计"><a href="#12-4-推荐的主键设计" class="headerlink" title="12.4 推荐的主键设计"></a>12.4 推荐的主键设计</h3><h4 id="1、非核心业务"><a href="#1、非核心业务" class="headerlink" title="1、非核心业务"></a>1、非核心业务</h4><p>对应表的主键自增ID，如告警、日志、监控等信息。 </p>
<h4 id="2、核心业务"><a href="#2、核心业务" class="headerlink" title="2、核心业务"></a>2、核心业务</h4><p><strong>主键设计至少应该是全局唯一且是单调递增</strong>。全局唯一保证在各系统之间都是唯一的，单调 递增是希望插入时不影响数据库性能。 </p>
<p>这里推荐最简单的一种主键设计：UUID。 </p>
<h4 id="3、UUID的特点"><a href="#3、UUID的特点" class="headerlink" title="3、UUID的特点"></a>3、UUID的特点</h4><p>全局唯一，占用36字节，数据无序，插入性能差。 </p>
<p>MySQL数据库的UUID组成如下所示：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">UUID <span class="token operator">=</span> 时间<span class="token operator">+</span>UUID版本（<span class="token number">16</span>字节）<span class="token operator">-</span> 时钟序列（<span class="token number">4</span>字节） <span class="token operator">-</span> MAC地址（<span class="token number">12</span>字节）<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们以UUID值e0ea12d4-6473-11eb-943c-00155dbaa39d举例：</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080031251.png" alt="image-20220628230044340"></p>
<p>&#x3D;&#x3D;为什么UUID是全局唯一的？&#x3D;&#x3D; </p>
<p>​	在UUID中时间部分占用60位，存储的类似TIMESTAMP的时间戳，但表示的是从1582-10-15 00：00：00.00 到现在的100ns的计数。可以看到UUID存储的时间精度比TIMESTAMPE更高，时间维度发生重复的概率降 低到1&#x2F;100ns。 时钟序列是为了避免时钟被回拨导致产生时间重复的可能性。MAC地址用于全局唯一。 </p>
<p>&#x3D;&#x3D;为什么UUID占用36个字节？&#x3D;&#x3D; </p>
<p>​	UUID根据字符串进行存储，设计时还带有无用”-“字符串，因此总共需要36个字节。 </p>
<p>&#x3D;&#x3D;为什么UUID是随机无序的呢？&#x3D;&#x3D; </p>
<p>​	因为UUID的设计中，将时间低位放在最前面，而这部分的数据是一直在变化的，并且是无序。</p>
<h4 id="4、改造UUID"><a href="#4、改造UUID" class="headerlink" title="4、改造UUID"></a>4、改造UUID</h4><p>​	若将时间高低位互换，则时间就是单调递增的了，也就变得单调递增了。MySQL 8.0可以更换时间低位和 时间高位的存储方式，这样UUID就是有序的UUID了。 </p>
<p>​	MySQL 8.0还解决了UUID存在的空间占用的问题，除去了UUID字符串中无意义的”-“字符串，并且将字符 串用二进制类型保存，这样存储空间降低为了16字节。 </p>
<p>​	可以通过MySQL8.0提供的uuid_to_bin函数实现上述功能，同样的，MySQL也提供了bin_to_uuid函数进行 转化：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SET</span> <span class="token variable">@uuid</span> <span class="token operator">=</span> UUID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token variable">@uuid</span><span class="token punctuation">,</span>uuid_to_bin<span class="token punctuation">(</span><span class="token variable">@uuid</span><span class="token punctuation">)</span><span class="token punctuation">,</span>uuid_to_bin<span class="token punctuation">(</span><span class="token variable">@uuid</span><span class="token punctuation">,</span><span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- uuid_to_bin(@uuid) 转成16进制存储</span>
<span class="token comment">-- uuid_to_bin(@uuid,TRUE); 修改成先高位 中位 地位，就可以保证uuid地政了</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080030797.png" alt="image-20220628230112814"></p>
<p>​	<strong>通过函数uuid_to_bin(@uuid,true)将UUID转化为有序UUID了</strong>。全局唯一 + 单调递增，这不就是我们想要 的主键！</p>
<h4 id="5、有序UUID性能测试"><a href="#5、有序UUID性能测试" class="headerlink" title="5、有序UUID性能测试"></a>5、有序UUID性能测试</h4><p>​	16字节的有序UUID，相比之前8字节的自增ID，性能和存储空间对比究竟如何呢？ </p>
<p>​	我们来做一个测试，插入1亿条数据，每条数据占用500字节，含有3个二级索引，最终的结果如下所示：</p>
<p><img src="/medias/loading.gif" data-original="https://raw.githubusercontent.com/luyaguo/pictures-guo/main/mysql/202508080030408.png" alt="image-20220628230134271"></p>
<p>​	从上图可以看到插入1亿条数据有序UUID是最快的，而且在实际业务使用中有序UUID在 <strong>业务端就可以生成</strong> 。还可以进一步减少SQL的交互次数。 </p>
<p>​	另外，虽然有序UUID相比自增ID多了8个字节，但实际只增大了3G的存储空间，还可以接受。</p>
<blockquote>
<p>​	在当今的互联网环境中，非常不推荐自增ID作为主键的数据库设计。更推荐类似有序UUID的全局唯一的实现。 </p>
<p>​	另外在真实的业务系统中，主键还可以加入业务和系统属性，如用户的尾号，机房的信息等。这样 的主键设计就更为考验架构师的水平了</p>
</blockquote>
<h4 id="6、如果不是MySQL8-0-肿么办？"><a href="#6、如果不是MySQL8-0-肿么办？" class="headerlink" title="6、如果不是MySQL8.0 肿么办？"></a>6、如果不是MySQL8.0 肿么办？</h4><p>​	手动赋值字段做主键！ </p>
<p>​	比如，设计各个分店的会员表的主键，因为如果每台机器各自产生的数据需要合并，就可能会出现主键 重复的问题。 </p>
<p>​	可以在总部 MySQL 数据库中，有一个管理信息表，在这个表中添加一个字段，专门用来记录当前会员编 号的最大值。 </p>
<p>​	门店在添加会员的时候，先到总部 MySQL 数据库中获取这个最大值，在这个基础上加 1，然后用这个值 作为新会员的“id”，同时，更新总部 MySQL 数据库管理信息表中的当 前会员编号的最大值。 </p>
<p>​	这样一来，各个门店添加会员的时候，都对同一个总部 MySQL 数据库中的数据表字段进 行操作，就解 决了各门店添加会员时会员编号冲突的问题。</p>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/MySQL-%E8%BF%9B%E9%98%B6/">
                                    <span class="chip bg-color">MySQL 进阶</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/bg.webp") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'XGAJufgp6Z2bX17baB3E7enQ-gzGzoHsz',
        appKey: 'j9yun8pjBYMNT3Gg8ehomdsf',
        serverURLs: 'https://xgajufgp.lc-cn-n1-shared.com',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'en',
        placeholder: '支持markdown格式以及丰富的小表情，快来留下些记忆吧~'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/posts/3e950832.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="第十一章 数据库的设计规范">
                        
                        <span class="card-title">第十一章 数据库的设计规范</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-08-09
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/MySQL-%E8%BF%9B%E9%98%B6/" class="post-category">
                                    MySQL 进阶
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MySQL-%E8%BF%9B%E9%98%B6/">
                        <span class="chip bg-color">MySQL 进阶</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/8d076785.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="第九章 性能分析工具的使用">
                        
                        <span class="card-title">第九章 性能分析工具的使用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-08-02
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/MySQL-%E8%BF%9B%E9%98%B6/" class="post-category">
                                    MySQL 进阶
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MySQL-%E8%BF%9B%E9%98%B6/">
                        <span class="chip bg-color">MySQL 进阶</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'From: 向阳<br />'
            + 'Author: 向阳<br />'
            + 'Link: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="8428618004"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2024-2025</span>
            
            <a href="/about" target="_blank">向阳</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;Total Words:&nbsp;<span
                        class="white-color">1457.8k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <a style="margin-inline:5px" target="_blank" href="https://hexo.io"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="基于Hexo框架"></a>
            <a style="margin-inline:5px" target="_blank" href="https://github.com/blinkfox/hexo-theme-matery"><img src="https://img.shields.io/badge/Theme-Matery-7138b6?style=flat&logo=MEGA" title="Themes Matery"></a>
            <a style="margin-inline:5px" target="_blank" href="https://cloudflare.com"><img src="https://img.shields.io/badge/Hosted-Cloudflare-brightgreen?style=flat&logo=Cloudflare" title="基于Cloudflare Pages托管部署"></a>
            <a style="margin-inline:5px" target="_blank" href="https://github.com"><img src="https://img.shields.io/badge/Source-Github-67e1fb?style=flat&logo=GitHub" title="静态文件托管于GitHub"></a>
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2024";
                        var startMonth = "5";
                        var startDate = "20";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'en';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/luyaguo" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:luyaguo839@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/star.js"><\/script>');
            }
        </script>
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

    <!-- 冒泡 -->
    

    <!--全屏-->
    <script src="/js/fullscreen.js" type="module"></script>

        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z\d\-\.\+]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(t.test(e.href)||r.test(e.href))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,d=o();function o(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=o());for(var e,i=0;i<d.length;i++)0<=(e=(e=d[i]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,a,n,o=d[i];e=function(){d=d.filter(function(t){return o!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(o)},(t=o).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,n=t.getAttribute("data-original"),a.onload=function(){t.src=n,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=n},t.src!==n&&(a.src=n)))}()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)}(this);</script></body>

</html>
